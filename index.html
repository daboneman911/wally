<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Web App Capability -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WallyTracker">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Wally Dashboard</title>
    
    <!-- Using Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary: #000000;
            --bg: #ffffff;
            --card-bg: #f5f5f5;
            --text-main: #000000;
            --text-sub: #757575;
            
            /* Circle Colors */
            --bay-green: #4cd964;
            --bay-purple: #bf5af2;
            --bay-orange: #ff9500;
            
            /* iOS Safe Area handling for Dynamic Island (iPhone 14/15/16 Pro) */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --tab-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100dvh;
            width: 100vw;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }

        /* --- NATIVE APP LAYOUT --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            /* Padding top adjusted to clear Dynamic Island */
            padding-top: calc(var(--safe-top) + 10px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-content {
            flex: 1;
            display: none;
            padding: 0 20px;
            padding-bottom: calc(var(--tab-height) + var(--safe-bottom) + 30px);
        }

        .tab-content.active { display: block; }

        /* --- BUTTONS & ACTIONS --- */
        .top-actions {
            display: flex;
            gap: 12px;
            padding: 10px 0 20px 0;
            justify-content: center;
        }

        .action-btn {
            background: #000;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* --- HEADER --- */
        .dashboard-header {
            background: #f2f2f7;
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            margin-bottom: 25px;
        }

        .app-title { font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -0.5px; }
        .app-subtitle { font-size: 14px; color: var(--text-sub); margin-top: 4px; }
        .header-bar { display: flex; justify-content: center; align-items: center; position: relative; height: 50px; margin: 10px 0; }
        .header-bar h1 { font-size: 22px; font-weight: 800; margin: 0; }
        .header-right { position: absolute; right: 0; display: flex; gap: 8px; }

        .icon-btn-round {
            width: 40px; height: 40px; border-radius: 50%; background: #f2f2f7; border: none;
            display: flex; align-items: center; justify-content: center; font-size: 20px; color: #000;
        }

        .section-title { font-size: 19px; font-weight: 800; margin-bottom: 15px; color: #000; text-align: center; }

        /* --- STATS GRID --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .stat-card {
            background: var(--card-bg); border-radius: 18px; padding: 18px;
            display: flex; flex-direction: column; justify-content: space-between; min-height: 90px;
        }
        .stat-label { font-size: 11px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 30px; font-weight: 800; color: #000; line-height: 1; margin-top: 5px; }

        /* --- BAYS GRID --- */
        .bays-grid { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-bottom: 30px; }
        .bay-circle {
            width: 62px; height: 62px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 20px; font-weight: 800; color: #000;
            position: relative; box-shadow: 0 3px 8px rgba(0,0,0,0.08); transition: transform 0.1s;
        }
        .bay-circle:active { transform: scale(0.92); }
        .bay-circle.unavailable { background: #8e8e93 !important; opacity: 0.4; }

        .bay-9 { background-color: var(--bay-green); }
        .bay-10 { background-color: var(--bay-purple); }
        .bay-11 { background-color: var(--bay-orange); }
        .bay-12 { background-color: var(--bay-purple); }
        .bay-13 { background-color: var(--bay-orange); }
        .bay-14 { background-color: var(--bay-orange); }
        .bay-15 { background-color: var(--bay-orange); }
        .bay-16 { background-color: var(--bay-orange); }

        .type-badge {
            position: absolute; bottom: -2px; right: -2px; width: 24px; height: 24px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 900; color: white; border: 2px solid white; background: #000;
        }

        /* --- ACTIVE TAB LIST --- */
        .active-card {
            background: white; border: 2px solid #000; border-radius: 18px; padding: 18px;
            margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-start;
        }
        .door-pill { background: #000; color: white; font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px; }

        /* --- STAFFING --- */
        .staff-card { background: white; border: 1px solid #e5e5ea; border-radius: 16px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .staff-hours { font-size: 16px; font-weight: 800; color: #000; }

        /* --- SETTINGS: REWORKED --- */
        .settings-header { font-size: 20px; font-weight: 800; margin: 25px 0 10px 0; color: #000; }
        .settings-group { background: #fff; border-radius: 16px; overflow: hidden; border: 1px solid #e5e5ea; margin-bottom: 20px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid #f2f2f7; }
        .settings-row:last-child { border-bottom: none; }
        .settings-label { font-size: 16px; font-weight: 600; }

        /* Reworked Attribution Slider */
        .slider-container { padding: 20px 16px; }
        .slider-wrapper { position: relative; width: 100%; height: 44px; display: flex; align-items: center; margin: 15px 0; }
        .slider-track { position: absolute; width: 100%; height: 8px; background: #e5e5ea; border-radius: 4px; }
        .slider-fill { position: absolute; height: 8px; background: #000; border-radius: 4px; }
        .slider-thumb { 
            position: absolute; width: 30px; height: 30px; background: #fff; border: 3px solid #000; 
            border-radius: 50%; transform: translateX(-50%); box-shadow: 0 3px 10px rgba(0,0,0,0.15); z-index: 5;
        }
        .slider-ticks { display: flex; justify-content: space-between; position: absolute; width: 100%; top: 32px; pointer-events: none; }
        .slider-tick { width: 2px; height: 8px; background: #ccc; position: relative; }
        .slider-tick-label { position: absolute; top: 12px; font-size: 11px; font-weight: 700; color: #8e8e93; transform: translateX(-50%); }

        .attribution-display { text-align: center; background: #f9f9f9; padding: 10px; border-radius: 10px; font-size: 13px; font-weight: 600; color: #666; margin-top: 10px; }

        /* --- NAVIGATION --- */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            height: calc(75px + var(--safe-bottom)); display: flex; justify-content: space-around;
            padding-bottom: var(--safe-bottom); border-top: 1px solid rgba(0,0,0,0.05); z-index: 1000;
        }
        .tab-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #ccc; width: 60px; gap: 4px; }
        .tab-btn.active { color: #000; }
        .tab-btn i { font-size: 24px; }
        .tab-btn span { font-size: 10px; font-weight: 700; }
        .tab-badge { position: absolute; top: 10px; right: 5px; background: #ff3b30; color: white; font-size: 10px; font-weight: 800; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; border: 2px solid white; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(5px); }
        .modal-sheet { background: white; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 25px; padding-bottom: calc(30px + var(--safe-bottom)); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .form-input { width: 100%; padding: 16px; background: #f2f2f7; border: none; border-radius: 14px; font-size: 17px; margin-bottom: 12px; outline: none; }
        .type-selector { display: flex; background: #f2f2f7; padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .type-opt { flex: 1; text-align: center; padding: 10px; border-radius: 10px; font-weight: 700; color: #8e8e93; }
        .type-opt.selected { background: white; color: #000; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .btn-primary { width: 100%; padding: 16px; border-radius: 14px; border: none; font-size: 17px; font-weight: 700; background: #000; color: white; cursor: pointer; }
        .btn-cancel { background: transparent; color: #8e8e93; width: 100%; padding: 12px; border: none; font-weight: 600; margin-top: 5px; }

        /* Toggle */
        .toggle-switch { width: 50px; height: 30px; background: #e5e5ea; border-radius: 15px; position: relative; }
        .toggle-switch.checked { background: #34c759; }
        .toggle-switch::after { content: ''; position: absolute; left: 2px; top: 2px; width: 26px; height: 26px; background: white; border-radius: 50%; transition: left 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .toggle-switch.checked::after { left: 22px; }

    </style>
</head>
<body>

<div class="app-container">
    
    <!-- === TAB 1: DASHBOARD === -->
    <div id="tab-dashboard" class="tab-content active">
        <div class="top-actions">
            <button class="action-btn" onclick="openAddUnloaderModal()"><i class="ph ph-user-plus"></i> Unloader</button>
            <button class="action-btn" onclick="openArrivalModal()"><i class="ph ph-truck"></i> Onboard</button>
        </div>

        <div class="dashboard-header">
            <h1 class="app-title">Wally Dashboard</h1>
            <div class="app-subtitle">by Fitz Joseph • v3.6.1</div>
        </div>

        <div class="section-title">Sort Statistics</div>
        <div class="stats-grid">
            <div class="stat-card" onclick="switchTab('logs')">
                <div class="stat-label">Total Wallies</div>
                <div class="stat-value" id="stat-total-wally">0</div>
            </div>
            <div class="stat-card" onclick="switchTab('logs')">
                <div class="stat-label">Total CPUs</div>
                <div class="stat-value" id="stat-total-cpu">0</div>
            </div>
        </div>

        <div class="section-title">Active Trailers</div>
        <div id="active-trailers-grid" class="bays-grid"></div>

        <div class="section-title">Open Bays</div>
        <div id="open-bays-grid" class="bays-grid"></div>
    </div>

    <!-- === TAB 2: ACTIVE === -->
    <div id="tab-active" class="tab-content">
        <div class="header-bar"><h1>Active Details</h1></div>
        <div id="active-tab-list"></div>
    </div>

    <!-- === TAB 3: LOGS === -->
    <div id="tab-logs" class="tab-content">
        <div class="header-bar">
            <h1>Logs</h1>
            <div class="header-right">
                <button class="icon-btn-round" onclick="openExportModal()"><i class="ph ph-export"></i></button>
            </div>
        </div>
        <div id="logs-list"></div>
    </div>

    <!-- === TAB 4: STAFFING === -->
    <div id="tab-staffing" class="tab-content">
        <div class="header-bar">
            <h1>Staffing</h1>
            <div class="header-right">
                <button class="icon-btn-round" onclick="openAddStaffModal()"><i class="ph ph-plus"></i></button>
            </div>
        </div>
        <div class="dashboard-header" style="background:#000; color:#fff; text-align:left;">
            <div class="stat-label" style="color:rgba(255,255,255,0.6)">Total Unloader Hours</div>
            <div class="stat-value" id="staff-total-hours" style="color:#fff">0.00</div>
        </div>
        <div id="staff-list-active"></div>
    </div>

    <!-- === TAB 5: TOOLS === -->
    <div id="tab-tools" class="tab-content">
        <div class="header-bar"><h1>Tools</h1></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="stat-card" onclick="openPPHModal()" style="text-align:center; align-items:center;">
                <i class="ph ph-calculator" style="font-size:32px; margin-bottom:10px;"></i>
                <div class="stat-label">PPH Calculator</div>
            </div>
        </div>
    </div>

    <!-- === TAB 6: SETTINGS === -->
    <div id="tab-settings" class="tab-content" style="background:#f2f2f7; padding:0;">
        <div style="background:#fff; padding:20px 20px 10px 20px; border-bottom:1px solid #e5e5ea;">
            <h1 style="font-size:28px; font-weight:800; margin:0;">Settings</h1>
        </div>

        <div style="padding:20px;">
            <!-- REWORKED: SHIFT SETTINGS AT TOP -->
            <div class="settings-header">Shift Configuration</div>
            <div class="settings-group">
                <div class="settings-row">
                    <span class="settings-label">Shift Start Time</span>
                    <input type="time" id="setting-shift-start" style="border:none; font-size:16px; background:#f2f2f7; padding:8px; border-radius:8px;" onchange="saveShiftStart(this.value)">
                </div>
                
                <div class="slider-container">
                    <div style="display:flex; justify-content:space-between; align-items:baseline;">
                        <span class="settings-label">Attribution Window</span>
                        <span style="font-size:20px; font-weight:800;" id="attr-val-display">5m</span>
                    </div>
                    <div class="slider-wrapper">
                        <div class="slider-track"></div>
                        <div class="slider-fill" id="slider-fill"></div>
                        <div class="slider-thumb" id="slider-thumb"></div>
                        <div class="slider-ticks">
                            <div class="slider-tick" style="left:0%"><span class="slider-tick-label">0</span></div>
                            <div class="slider-tick" style="left:50%"><span class="slider-tick-label">5</span></div>
                            <div class="slider-tick" style="left:100%"><span class="slider-tick-label">10</span></div>
                        </div>
                    </div>
                    <div class="attribution-display" id="attr-text">Window: 0 to 5 minutes after hour</div>
                </div>

                <div class="settings-row">
                    <span class="settings-label">Disable Window</span>
                    <div class="toggle-switch" id="switch-dis-window" onclick="toggleSwitch('dis-window')"></div>
                </div>
            </div>

            <div class="settings-header">App Controls</div>
            <div class="settings-group">
                <div class="settings-row">
                    <span class="settings-label">Demo Mode</span>
                    <div class="toggle-switch" id="switch-demo-mode" onclick="toggleSwitch('demo-mode')"></div>
                </div>
                <div class="settings-row" onclick="resetData()">
                    <span class="settings-label" style="color:#ff3b30; font-weight:700;">Reset All Data</span>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- === NAVIGATION === -->
<nav class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('dashboard', this)"><i class="ph-fill ph-chart-pie-slice"></i><span>Home</span></button>
    <button class="tab-btn" onclick="switchTab('active', this)"><i class="ph-fill ph-truck-trailer"></i><span>Active</span><span class="tab-badge" id="badge-active">0</span></button>
    <button class="tab-btn" onclick="switchTab('logs', this)"><i class="ph-fill ph-list-dashes"></i><span>Logs</span></button>
    <button class="tab-btn" onclick="switchTab('staffing', this)"><i class="ph-fill ph-users"></i><span>Staffing</span></button>
    <button class="tab-btn" onclick="switchTab('tools', this)"><i class="ph-fill ph-toolbox"></i><span>Tools</span></button>
    <button class="tab-btn" onclick="switchTab('settings', this)"><i class="ph-fill ph-gear"></i><span>Settings</span></button>
</nav>

<!-- === MODALS === -->
<div class="modal-overlay" id="input-modal">
    <div class="modal-sheet">
        <h2 style="text-align:center; margin-top:0;">Onboard Door <span id="modal-door-num"></span></h2>
        <div class="type-selector">
            <div class="type-opt selected" id="opt-wally" onclick="setType('Wally')">Wally</div>
            <div class="type-opt" id="opt-cpu" onclick="setType('CPU')">CPU (53')</div>
        </div>
        <input type="text" id="input-id" class="form-input" placeholder="ID Number" autocapitalize="characters">
        <input type="text" id="input-unloader" class="form-input" placeholder="Unloader Name (Optional)" autocapitalize="words">
        <button class="btn-primary" onclick="confirmArrival()">Start Unload</button>
        <button class="btn-cancel" onclick="closeModal('input-modal')">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="pph-modal">
    <div class="modal-sheet">
        <h2 style="text-align:center;">PPH Calculator</h2>
        <input type="number" id="pph-vol" class="form-input" placeholder="Package Volume">
        <input type="number" id="pph-hrs" class="form-input" placeholder="Total Hours">
        <div style="text-align:center; font-size:40px; font-weight:900; margin:20px 0;" id="pph-result">0</div>
        <button class="btn-primary" onclick="calculatePPH()">Calculate</button>
        <button class="btn-cancel" onclick="closeModal('pph-modal')">Close</button>
    </div>
</div>

<div class="modal-overlay" id="hour-attribution-modal">
    <div class="modal-sheet">
        <h2 style="text-align:center;">Attribute Completion</h2>
        <p style="text-align:center; color:#666;">This was finished within the attribution window. Which hour should it count for?</p>
        <button class="btn-primary" onclick="resolveAttribution('Previous')">Previous Hour</button>
        <button class="btn-primary" style="background:#f2f2f7; color:#000; margin-top:10px;" onclick="resolveAttribution('Current')">Current Hour</button>
    </div>
</div>

<script>
    // --- APP STATE ---
    let doors = JSON.parse(localStorage.getItem('ps9_doors')) || {};
    let historyLog = JSON.parse(localStorage.getItem('ps9_history')) || [];
    let staffing = JSON.parse(localStorage.getItem('ps9_staffing')) || [];
    let attributionConfig = JSON.parse(localStorage.getItem('ps9_attribution_config')) || { minutesAfterHour: 5, enabled: true };
    
    let currentDoor = null;
    let currentType = 'Wally';
    let pendingCompletion = null;

    const DOORS_START = 9;
    const DOORS_END = 16;

    function init() {
        if (Object.keys(doors).length === 0) {
            for(let i=DOORS_START; i<=DOORS_END; i++) {
                doors[i] = { status: 'empty', start: 0, id: '', type: '', unloader: '', unavailable: false, lastCompletionTime: null };
            }
        }
        document.getElementById('setting-shift-start').value = localStorage.getItem('ps9_shift_start') || "19:55";
        renderDashboard();
        updateAttributionUI();
        setupSlider();
        updateTabBadges();
        setInterval(updateStaffingTimers, 1000);
    }

    // --- NAVIGATION ---
    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(tabId === 'dashboard') renderDashboard();
        if(tabId === 'active') renderActiveTab();
        if(tabId === 'logs') renderLogs();
        if(tabId === 'staffing') renderStaffingView();
    }

    // --- DASHBOARD ---
    function renderDashboard() {
        const ag = document.getElementById('active-trailers-grid');
        const og = document.getElementById('open-bays-grid');
        ag.innerHTML = ''; og.innerHTML = '';

        let totalW = 0, totalC = 0;
        historyLog.forEach(l => { if(l.type === 'Wally') totalW++; else totalC++; });
        document.getElementById('stat-total-wally').innerText = totalW;
        document.getElementById('stat-total-cpu').innerText = totalC;

        for(let i=DOORS_START; i<=DOORS_END; i++) {
            const d = doors[i];
            const btn = document.createElement('div');
            btn.className = `bay-circle bay-${i} ${d.unavailable ? 'unavailable' : ''}`;
            btn.innerText = i;
            
            if(d.status === 'active') {
                const badge = document.createElement('div');
                badge.className = 'type-badge';
                badge.innerText = d.type === 'Wally' ? 'W' : 'C';
                btn.appendChild(badge);
                btn.onclick = () => openActiveDetails(i);
                ag.appendChild(btn);
            } else {
                btn.onclick = () => openArrivalModal(i);
                og.appendChild(btn);
            }
        }
    }

    function openActiveDetails(doorNum) {
        if(confirm(`Complete Unload for Door ${doorNum}?`)) {
            completeDoor(doorNum);
        }
    }

    // --- ONBOARDING ---
    function openArrivalModal(doorNum) {
        currentDoor = doorNum;
        document.getElementById('modal-door-num').innerText = doorNum;
        document.getElementById('input-id').value = '';
        document.getElementById('input-modal').style.display = 'flex';
        setTimeout(() => document.getElementById('input-id').focus(), 100);
    }

    function setType(t) {
        currentType = t;
        document.getElementById('opt-wally').classList.toggle('selected', t === 'Wally');
        document.getElementById('opt-cpu').classList.toggle('selected', t === 'CPU');
    }

    function confirmArrival() {
        const id = document.getElementById('input-id').value.toUpperCase();
        if(!id) return;
        doors[currentDoor] = {
            status: 'active', start: Date.now(), id: id, unloader: document.getElementById('input-unloader').value || "Unassigned", type: currentType
        };
        saveData();
        closeModal('input-modal');
        renderDashboard();
        updateTabBadges();
    }

    // --- COMPLETION & ATTRIBUTION ---
    function completeDoor(doorNum) {
        const now = new Date();
        const mins = now.getMinutes();
        const inWindow = mins < attributionConfig.minutesAfterHour;

        if (attributionConfig.enabled && inWindow) {
            pendingCompletion = { doorNum, time: now.getTime() };
            document.getElementById('hour-attribution-modal').style.display = 'flex';
        } else {
            finalizeCompletion(doorNum, now.getTime(), 0);
        }
    }

    function resolveAttribution(choice) {
        let offset = 0;
        if(choice === 'Previous') {
            offset = (new Date(pendingCompletion.time).getMinutes() + 1) * 60000;
        }
        finalizeCompletion(pendingCompletion.doorNum, pendingCompletion.time, offset);
        closeModal('hour-attribution-modal');
    }

    function finalizeCompletion(doorNum, end, offset) {
        const d = doors[doorNum];
        historyLog.unshift({ ...d, end: end, offset: offset });
        doors[doorNum] = { status: 'empty', start: 0, id: '', type: '', unloader: '', unavailable: false, lastCompletionTime: end };
        saveData();
        renderDashboard();
        updateTabBadges();
    }

    // --- STAFFING ---
    function openAddStaffModal() {
        const name = prompt("Enter Staff Name:");
        if(name) {
            staffing.push({ id: Date.now(), name: name, start: Date.now(), role: 'Unloader', status: 'active', accumulated: 0 });
            saveData(); renderStaffingView();
        }
    }

    function renderStaffingView() {
        const list = document.getElementById('staff-list-active');
        list.innerHTML = '';
        staffing.forEach(s => {
            const div = document.createElement('div');
            div.className = 'staff-card';
            div.innerHTML = `<div><strong>${s.name}</strong><br><small>${s.role}</small></div><div class="staff-hours" id="hr-${s.id}">0.00h</div>`;
            list.appendChild(div);
        });
    }

    function updateStaffingTimers() {
        let total = 0;
        staffing.forEach(s => {
            let ms = s.accumulated + (Date.now() - s.start);
            let hrs = ms / 3600000;
            const el = document.getElementById(`hr-${s.id}`);
            if(el) el.innerText = hrs.toFixed(2) + 'h';
            if(s.role === 'Unloader') total += hrs;
        });
        document.getElementById('staff-total-hours').innerText = total.toFixed(2);
    }

    // --- LOGS ---
    function renderLogs() {
        const list = document.getElementById('logs-list');
        list.innerHTML = historyLog.length ? '' : '<p style="text-align:center; color:#999;">No logs found</p>';
        historyLog.forEach(l => {
            const div = document.createElement('div');
            div.className = 'active-card';
            div.innerHTML = `<div><span class="door-pill">Door ${l.door}</span> <strong>${l.id}</strong><br><small>${l.unloader} • ${l.type}</small></div><div style="font-size:12px; text-align:right;">${new Date(l.end).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
            list.appendChild(div);
        });
    }

    // --- SLIDER LOGIC ---
    function setupSlider() {
        const thumb = document.getElementById('slider-thumb');
        const track = thumb.parentElement;
        let dragging = false;
        const update = (clientX) => {
            const rect = track.getBoundingClientRect();
            let p = ((clientX - rect.left) / rect.width) * 100;
            p = Math.max(0, Math.min(100, p));
            attributionConfig.minutesAfterHour = Math.round((p / 100) * 10);
            updateAttributionUI();
        };
        thumb.addEventListener('touchstart', (e) => { dragging = true; e.preventDefault(); });
        document.addEventListener('touchmove', (e) => { if(dragging) update(e.touches[0].clientX); });
        document.addEventListener('touchend', () => { dragging = false; saveData(); });
    }

    function updateAttributionUI() {
        const p = (attributionConfig.minutesAfterHour / 10) * 100;
        document.getElementById('slider-fill').style.width = p + '%';
        document.getElementById('slider-thumb').style.left = p + '%';
        document.getElementById('attr-val-display').innerText = attributionConfig.minutesAfterHour + 'm';
        document.getElementById('attr-text').innerText = `Window: 0 to ${attributionConfig.minutesAfterHour} minutes after hour mark`;
        
        const toggle = document.getElementById('switch-dis-window');
        if(!attributionConfig.enabled) toggle.classList.add('checked');
        else toggle.classList.remove('checked');
    }

    // --- UTILS ---
    function updateTabBadges() {
        let active = 0;
        for(let i=DOORS_START; i<=DOORS_END; i++) if(doors[i].status === 'active') active++;
        document.getElementById('badge-active').innerText = active;
        document.getElementById('badge-active').style.display = active > 0 ? 'flex' : 'none';
    }
    function toggleSwitch(id) {
        const el = document.getElementById('switch-' + id);
        el.classList.toggle('checked');
        if(id === 'dis-window') attributionConfig.enabled = !el.classList.contains('checked');
        saveData();
    }
    function saveShiftStart(v) { localStorage.setItem('ps9_shift_start', v); }
    function saveData() {
        localStorage.setItem('ps9_doors', JSON.stringify(doors));
        localStorage.setItem('ps9_history', JSON.stringify(historyLog));
        localStorage.setItem('ps9_staffing', JSON.stringify(staffing));
        localStorage.setItem('ps9_attribution_config', JSON.stringify(attributionConfig));
    }
    function resetData() { if(confirm("Clear all data?")) { localStorage.clear(); location.reload(); } }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function calculatePPH() {
        const v = parseFloat(document.getElementById('pph-vol').value) || 0;
        const h = parseFloat(document.getElementById('pph-hrs').value) || 0;
        document.getElementById('pph-result').innerText = h > 0 ? Math.round(v/h) : 0;
    }

    init();
</script>
</body>
</html>
