<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wally Tracker</title>

  <!-- Icons (matches your existing ph-* usage) -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    :root{
      --bg:#0b0b10;
      --card:#141420;
      --card2:#1b1b2a;
      --text:#ffffff;
      --muted:#a4a4b5;
      --line:rgba(255,255,255,.08);
      --pill:#24243a;
      --pill2:#2c2c46;
      --danger:#ff453a;
      --warn:#ff9f0a;
      --ok:#34c759;
      --accent:#0a84ff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg, #07070b, #0b0b10);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }
    .app{
      max-width:1100px;
      margin:0 auto;
      padding:18px 14px 40px;
    }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      background:rgba(20,20,32,.7);
      border:1px solid var(--line);
      border-radius:14px;
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .brand .logo{
      width:36px;height:36px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#7c3aed);
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.2);
    }
    .brand .logo i{font-size:18px}
    .brand .title{
      display:flex;flex-direction:column;line-height:1.1;
    }
    .brand .title strong{font-size:16px}
    .brand .title span{font-size:12px;color:var(--muted)}
    .app-version{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      white-space:nowrap;
    }

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      margin:14px 0 10px;
    }
    .tab{
      padding:10px 12px;border-radius:999px;
      background:var(--pill);
      border:1px solid var(--line);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      display:flex;align-items:center;gap:8px;
      font-weight:600;font-size:13px;
    }
    .tab.active{
      background:var(--pill2);
      color:var(--text);
      border-color:rgba(255,255,255,.14);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:rgba(20,20,32,.86);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    .card h3{
      margin:0 0 10px;
      font-size:14px;
      color:var(--text);
      letter-spacing:.2px;
    }
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .spacer{height:8px}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .top-actions{
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
    }
    .action-btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      display:flex;gap:8px;align-items:center;
    }
    .action-btn:hover{background:rgba(255,255,255,.09)}
    .action-btn i{font-size:16px}

    .mini{
      padding:7px 10px;
      font-weight:700;
      font-size:12px;
    }
    .btn-primary{
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(135deg, rgba(10,132,255,.95), rgba(124,58,237,.9));
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .btn-primary:hover{filter:brightness(1.03)}
    .btn-cancel{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      width:100%;
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 700px){
      .kpis{grid-template-columns:1fr}
    }
    .kpi{
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .kpi .label{font-size:12px;color:var(--muted);font-weight:700}
    .kpi .value{font-size:20px;font-weight:900;margin-top:4px}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 700px){
      .form{grid-template-columns:1fr}
    }
    .form-group{
      display:flex;flex-direction:column;gap:6px;
    }
    .form-group label{
      font-size:12px;color:var(--muted);font-weight:700;
    }
    .form-input, select{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      color:var(--text);
      font-weight:700;
      outline:none;
    }
    select option{color:#000}

    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
    }
    .table th, .table td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-align:left;
      vertical-align:top;
    }
    .table th{
      color:var(--muted);
      font-weight:800;
      background:rgba(255,255,255,.04);
    }
    .table tr:last-child td{border-bottom:none}

    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      font-size:11px;font-weight:900;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      white-space:nowrap;
    }
    .tag.wally{border-color:rgba(52,199,89,.35);background:rgba(52,199,89,.12)}
    .tag.cpu{border-color:rgba(255,159,10,.35);background:rgba(255,159,10,.12)}
    .tag.cut{border-color:rgba(255,69,58,.35);background:rgba(255,69,58,.12)}
    .tag.active{border-color:rgba(10,132,255,.35);background:rgba(10,132,255,.12)}
    .tag.paused{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.08)}

    /* Modal */
    .modal-overlay{
      display:none;
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      align-items:center;justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal-sheet{
      width: min(680px, 100%);
      background:rgba(20,20,32,.96);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 20px 90px rgba(0,0,0,.6);
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:rgba(28,28,44,.95);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      display:none;
      z-index:10000;
      font-weight:800;
      font-size:13px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
    }

    .hidden{display:none}
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo"><i class="ph ph-truck"></i></div>
        <div class="title">
          <strong>Wally Tracker</strong>
          <span class="muted">Shift tracking • doors • staffing • reporting</span>
        </div>
      </div>
      <div class="app-version">Version 3.30</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-view="dashboard" onclick="switchView('dashboard')"><i class="ph ph-house"></i> Dashboard</div>
      <div class="tab" data-view="staffing" onclick="switchView('staffing')"><i class="ph ph-users"></i> Staffing</div>
      <div class="tab" data-view="logs" onclick="switchView('logs')"><i class="ph ph-list-bullets"></i> Logs</div>
      <div class="tab" data-view="settings" onclick="switchView('settings')"><i class="ph ph-gear"></i> Settings</div>
    </div>

    <!-- DASHBOARD -->
    <div id="view-dashboard">
      <div class="grid">
        <div class="card">
          <div class="top-actions">
            <button class="action-btn" onclick="openStartSortWizard()"><i class="ph ph-play"></i> Start Sort</button>

            <!-- v3.30: End Sort Summary Report -->
            <button class="action-btn" onclick="openEndSortModal()"><i class="ph ph-clipboard-text"></i> End Sort</button>

            <button class="action-btn" onclick="openModal('add-trailer-modal')"><i class="ph ph-plus"></i> Add Trailer</button>
            <button class="action-btn" onclick="openModal('export-modal')"><i class="ph ph-export"></i> Export</button>
            <button class="action-btn" onclick="openChangelog()"><i class="ph ph-note"></i> Changelog</button>
          </div>

          <div class="spacer"></div>

          <div class="row">
            <div class="pill" id="shift-pill"><i class="ph ph-clock"></i> Shift: <span id="shift-label">Not started</span></div>
            <div class="pill"><i class="ph ph-door"></i> Doors tracked: <span id="door-count">0</span></div>
            <div class="pill"><i class="ph ph-clipboard"></i> Logs: <span id="log-count">0</span></div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="label">Wally Completed</div>
              <div class="value" id="kpi-wally">0</div>
            </div>
            <div class="kpi">
              <div class="label">CPU Completed</div>
              <div class="value" id="kpi-cpu">0</div>
            </div>
            <div class="kpi">
              <div class="label">Total Man-Hours</div>
              <div class="value" id="kpi-mh">0.00</div>
            </div>
          </div>

          <div class="hr"></div>

          <h3>Active Doors</h3>
          <div id="doors-table-wrap"></div>

          <div class="hr"></div>

          <h3>Wally Completions by Hour (Wally Only)</h3>
          <div id="hourly-breakdown-wrap"></div>
        </div>

        <div class="card">
          <h3>Quick Actions</h3>
          <div class="row">
            <button class="action-btn mini" onclick="openModal('add-employee-modal')"><i class="ph ph-user-plus"></i> Add Employee</button>
            <button class="action-btn mini" onclick="openModal('backup-modal')"><i class="ph ph-cloud-arrow-up"></i> Backup</button>
            <button class="action-btn mini" onclick="openModal('restore-modal')"><i class="ph ph-cloud-arrow-down"></i> Restore</button>
            <button class="action-btn mini" onclick="resetAllDataConfirm()"><i class="ph ph-trash"></i> Reset</button>
          </div>

          <div class="hr"></div>

          <h3>Top Performer (Shift)</h3>
          <div id="top-performer-box" class="muted">n/a</div>

          <div class="hr"></div>

          <h3>Notes</h3>
          <div class="muted" style="line-height:1.35">
            Use <strong>Start Sort</strong> to set the shift start time. Add trailers as they are onboarded, then mark them complete to populate Logs and hourly breakdown.
          </div>
        </div>
      </div>
    </div>

    <!-- STAFFING -->
    <div id="view-staffing" class="hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Staffing</h3>
          <div class="row">
            <button class="action-btn mini" onclick="openModal('add-employee-modal')"><i class="ph ph-user-plus"></i> Add</button>
            <button class="action-btn mini" onclick="autoPauseCutCheck()"><i class="ph ph-check-circle"></i> Validate</button>
          </div>
        </div>

        <div class="spacer"></div>

        <div id="staffing-wrap"></div>
      </div>
    </div>

    <!-- LOGS -->
    <div id="view-logs" class="hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Logs</h3>
          <button class="action-btn mini" onclick="openModal('export-modal')"><i class="ph ph-export"></i> Export</button>
        </div>

        <div class="spacer"></div>

        <div class="form" style="grid-template-columns:1fr 1fr 1fr;">
          <div class="form-group">
            <label>Search (ID / Trailer)</label>
            <input class="form-input" id="log-search" placeholder="Type to filter..." oninput="renderLogs()"/>
          </div>
          <div class="form-group">
            <label>Type</label>
            <select id="log-type-filter" onchange="renderLogs()">
              <option value="All">All</option>
              <option value="Wally">Wally</option>
              <option value="CPU">CPU</option>
            </select>
          </div>
          <div class="form-group">
            <label>Date</label>
            <input class="form-input" type="date" id="log-date-filter" onchange="renderLogs()"/>
          </div>
        </div>

        <div class="spacer"></div>

        <div id="logs-wrap"></div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="view-settings" class="hidden">
      <div class="card">
        <h3>Settings</h3>

        <div class="row">
          <button class="action-btn" onclick="openChangelog()"><i class="ph ph-note"></i> View Changelog</button>
          <button class="action-btn" onclick="openModal('backup-modal')"><i class="ph ph-cloud-arrow-up"></i> Backup Logs Only</button>
          <button class="action-btn" onclick="openModal('restore-modal')"><i class="ph ph-cloud-arrow-down"></i> Restore</button>
          <button class="action-btn" onclick="resetAllDataConfirm()"><i class="ph ph-trash"></i> Reset All Data</button>
        </div>

        <div class="hr"></div>

        <h3>Data</h3>
        <div class="muted" style="line-height:1.4">
          Backups export JSON. Restore replaces current data with the imported backup.
        </div>
      </div>
    </div>
  </div>

  <!-- START SORT MODAL -->
  <div class="modal-overlay" id="start-sort-modal">
    <div class="modal-sheet">
      <h2 style="margin: 0 0 12px 0; font-size:24px; text-align:center;">Start Sort</h2>

      <div class="form">
        <div class="form-group">
          <label>Shift Start (Time)</label>
          <input class="form-input" type="time" id="shift-start-time"/>
        </div>
        <div class="form-group">
          <label>Date</label>
          <input class="form-input" type="date" id="shift-start-date"/>
        </div>
      </div>

      <div class="spacer"></div>

      <button class="btn-primary" onclick="saveShiftStart()">Save</button>
      <button class="btn-cancel" onclick="closeModal('start-sort-modal')" style="margin-top:10px">Cancel</button>
    </div>
  </div>

  <!-- ADD TRAILER MODAL -->
  <div class="modal-overlay" id="add-trailer-modal">
    <div class="modal-sheet">
      <h2 style="margin: 0 0 12px 0; font-size:24px; text-align:center;">Add Trailer</h2>

      <div class="form">
        <div class="form-group">
          <label>Trailer ID</label>
          <input class="form-input" id="trailer-id" placeholder="Example: 123456"/>
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="trailer-type">
            <option value="Wally">Wally</option>
            <option value="CPU">CPU</option>
          </select>
        </div>
        <div class="form-group">
          <label>Door</label>
          <input class="form-input" id="trailer-door" placeholder="Example: 12"/>
        </div>
        <div class="form-group">
          <label>Unloader</label>
          <select id="trailer-unloader"></select>
        </div>
      </div>

      <div class="spacer"></div>

      <button class="btn-primary" onclick="addTrailer()">Add</button>
      <button class="btn-cancel" onclick="closeModal('add-trailer-modal')" style="margin-top:10px">Cancel</button>
    </div>
  </div>

  <!-- EXPORT MODAL -->
  <div class="modal-overlay" id="export-modal">
    <div class="modal-sheet">
      <h2 style="margin: 0 0 12px 0; font-size:24px; text-align:center;">Export</h2>

      <div class="row">
        <button class="action-btn" onclick="exportLogsJSON()"><i class="ph ph-file-code"></i> Export Logs (JSON)</button>
        <button class="action-btn" onclick="exportSummaryText()"><i class="ph ph-text-aa"></i> Export Summary (Text)</button>
      </div>

      <div class="spacer"></div>

      <div class="muted" style="line-height:1.35">
        PDF export is intentionally omitted to keep this single-file build dependency-free. Use the <strong>End Sort</strong> copy-ready report for daily reporting.
      </div>

      <button class="btn-cancel" onclick="closeModal('export-modal')" style="margin-top:12px">Close</button>
    </div>
  </div>

  <!-- ADD EMPLOYEE MODAL -->
  <div class="modal-overlay" id="add-employee-modal">
    <div class="modal-sheet">
      <h2 style="margin: 0 0 12px 0; font-size:24px; text-align:center;">Add Employee</h2>

      <div class="form">
        <div class="form-group">
          <label>Name</label>
          <input class="form-input" id="emp-name" placeholder="Employee name"/>
        </div>
        <div class="form-group">
          <label>Role</label>
          <select id="emp-role">
            <option value="Unloader">Unloader</option>
            <option value="Belt Tender">Belt Tender</option>
            <option value="Bulk Sweep">Bulk Sweep</option>
          </select>
        </div>
      </div>

      <div class="spacer"></div>

      <button class="btn-primary" onclick="addEmployee()">Add</button>
      <button class="btn-cancel" onclick="closeModal('add-employee-modal')" style="margin-top:10px">Cancel</button>
    </div>
  </div>

  <!-- BACKUP MODAL -->
  <div class="modal-overlay" id="backup-modal">
    <div class="modal-sheet">
      <h2 style="margin: 0 0 12px 0; font-size:24px; text-align:center;">Backup</h2>

      <div class="muted" style="line-height:1.35">
        This exports <strong>Logs Only</strong> by default (matches your “Backup Logs Only” workflow). If you want full-state backup, use “Full Backup” below.
      </div>

      <div class="spacer"></div>

      <div class="row">
        <button class="action-btn" onclick="exportLogsJSON()"><i class="ph ph-file-code"></i> Backup Logs Only</button>
        <button class="action-btn" onclick="exportFullBackupJSON()"><i class="ph ph-package"></i> Full Backup</button>
      </div>

      <button class="btn-cancel" onclick="closeModal('backup-modal')" style="margin-top:12px">Close</button>
    </div>
  </div>

  <!-- RESTORE MODAL -->
  <div class="modal-overlay" id="restore-modal">
    <div class="modal-sheet">
      <h2 style="margin: 0 0 12px 0; font-size:24px; text-align:center;">Restore</h2>

      <div class="muted" style="line-height:1.35">
        Paste JSON below. If the JSON is logs-only, it will restore logs. If it is full backup, it will restore the entire app state.
      </div>

      <div class="spacer"></div>

      <textarea id="restore-json" class="form-input" style="height:220px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:12px;white-space:pre;"></textarea>

      <div class="spacer"></div>

      <button class="btn-primary" onclick="restoreFromJSON()">Restore</button>
      <button class="btn-cancel" onclick="closeModal('restore-modal')" style="margin-top:10px">Cancel</button>
    </div>
  </div>

  <!-- CHANGELOG MODAL -->
  <div class="modal-overlay" id="changelog-modal">
    <div class="modal-sheet">
      <h2 style="margin: 0 0 12px 0; font-size:24px; text-align:center;">Changelog</h2>
      <textarea id="changelog-text" class="form-input" readonly
        style="height:320px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:12px;line-height:1.35;white-space:pre;"></textarea>
      <button class="btn-cancel" onclick="closeModal('changelog-modal')" style="margin-top:10px">Close</button>
    </div>
  </div>

  <!-- v3.30: END SORT MODAL -->
  <div class="modal-overlay" id="end-sort-modal">
    <div class="modal-sheet">
      <h2 style="margin: 0 0 15px 0; font-size:24px; text-align:center;">End Sort Summary Report</h2>

      <textarea id="end-sort-summary-text"
        class="form-input"
        readonly
        style="height:240px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:13px; line-height:1.35; white-space:pre;"></textarea>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn-primary" onclick="copyEndSortSummary()" style="flex:1;">
          Copy Summary
        </button>
        <button class="btn-primary" onclick="regenerateEndSortSummary()" style="flex:1; background:#f2f2f7; color:#000;">
          Refresh
        </button>
      </div>

      <button class="btn-cancel" onclick="closeModal('end-sort-modal')" style="margin-top:10px;">Close</button>
    </div>
  </div>

  <div class="toast" id="toast">Saved ✓</div>

  <script>
    /***********************
     * VERSION + CHANGELOG
     ***********************/
    const APP_VERSION = '3.30';

    // NOTE: v3.29 appended without removing prior entries (per your request)
    const CHANGELOG = `
v3.30:
- Added "End Sort" Summary Report modal with one-tap copy (Slack/Teams/Email ready).
- Summary includes shift duration, totals (Wally vs CPU), total man-hours, and top performer (volume + rate).

v3.29:
- Standardized hour labels to "1st hour, 2nd hour, 3rd hour, 4th hour, 5th hour" (and beyond).
- Staffing: Belt Tender role now requires confirmation before switching to a different employee (max 1 on-clock).
- Staffing: Role limit enforcement ignores cut employees for Belt Tender / Bulk Sweep checks.

v3.27:
- New streamlined action buttons (compact pills).
- Color-coded status rings for active bays (Green < 45m, Red > 60m).

v3.26:
- Dynamic search in Logs (filters as you type).

v3.25:
- Added Date Filter to Logs (review previous days).

v3.24:
- Added "Backup Logs Only" (JSON) feature.
- Added visual "Saved ✓" confirmation toast.
- Clarified Backup/Restore options.

v3.23:
- Added Data Backup & Restore (JSON Export/Import) in Settings.

v3.22:
- Fixed bay door availability: Removed long-press.
- Added explicit "Mark Unavailable/Available" button to Onboard menu.
- Smoother transitions for marking bays unavailable (no alerts).

v3.21:
- Verified and Confirmed: "Reset All Data" safely preserves saved Account Numbers.

v3.20:
- Simplified Share Text to "Door X done".
- Filtered Hourly Breakdown to exclude CPUs (Wally Only).
- Added historical changelog data.

v3.19:
- Added search bar to logs (search by ID or Trailer).
- Added filter by Unloader to logs.
- Enhanced duplicate alerts with details (Time, Door, Who).
- Added Changelog view in Settings.

v3.18:
- Removed automatic role switching. Manual role assignment is now strictly respected.
- Fixed hour transfer logic. Hours now follow employee to their new role.

v3.17:
- Fixed staffing ranking to exclude "Cut" employees.
- Verified time calculations are rounded correctly.

v3.16:
- Added "Start Sort" wizard to set shift start time and DOP easily.
- First trailer added after "Start Sort" syncs to shift start time.
- Added ability to edit Start Time during onboarding.
`.trim();

    /***********************
     * STATE
     ***********************/
    const STORAGE_KEY = "wally_tracker_state_v1";

    // Doors currently active: door => { trailerId, type, unloader, startMs }
    let activeDoors = {};

    // Staffing: {id, name, role, status:'active'|'paused'|'cut', start:number|null, accumulated:number}
    let staffing = [];

    // Logs: { id, trailerId, type, door, unloader, start, end, durationMs }
    let historyLog = [];

    // Shift start time (ms) and date/time display
    let shiftStartMs = null;

    /***********************
     * INIT
     ***********************/
    (function init(){
      loadData();
      document.querySelector(".app-version").textContent = `Version ${APP_VERSION}`;
      renderAll();
      refreshTrailerUnloaderOptions();
    })();

    function renderAll(){
      updateHeaderPills();
      renderDoors();
      renderHourlyBreakdown();
      renderTopPerformer();
      renderStaffingView();
      renderLogs();
    }

    /***********************
     * VIEW NAV
     ***********************/
    function switchView(view){
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelector(`.tab[data-view="${view}"]`).classList.add("active");

      document.getElementById("view-dashboard").classList.add("hidden");
      document.getElementById("view-staffing").classList.add("hidden");
      document.getElementById("view-logs").classList.add("hidden");
      document.getElementById("view-settings").classList.add("hidden");

      document.getElementById(`view-${view}`).classList.remove("hidden");

      // Keep options fresh if staffing changed
      refreshTrailerUnloaderOptions();
      renderAll();
    }

    /***********************
     * MODALS
     ***********************/
    function openModal(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = "flex";

      // Modal-specific prefill
      if (id === 'add-trailer-modal'){
        refreshTrailerUnloaderOptions();
        document.getElementById("trailer-id").value = "";
        document.getElementById("trailer-door").value = "";
        document.getElementById("trailer-type").value = "Wally";
      }
      if (id === 'add-employee-modal'){
        document.getElementById("emp-name").value = "";
        document.getElementById("emp-role").value = "Unloader";
      }
      if (id === 'restore-modal'){
        document.getElementById("restore-json").value = "";
      }
    }
    function closeModal(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = "none";
    }

    /***********************
     * TOAST
     ***********************/
    function showSaveToast(){
      const t = document.getElementById("toast");
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.style.display="none", 1300);
    }

    /***********************
     * SHIFT START
     ***********************/
    function openStartSortWizard(){
      // default to now
      const now = new Date();
      const dateStr = now.toISOString().slice(0,10);
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');

      document.getElementById("shift-start-date").value = (shiftStartMs ? new Date(shiftStartMs).toISOString().slice(0,10) : dateStr);
      document.getElementById("shift-start-time").value = (shiftStartMs ? new Date(shiftStartMs) : now).toTimeString().slice(0,5);

      openModal("start-sort-modal");
    }

    function saveShiftStart(){
      const d = document.getElementById("shift-start-date").value;
      const t = document.getElementById("shift-start-time").value;
      if (!d || !t) return alert("Please select date and time.");

      const [yyyy,mm,dd] = d.split("-").map(Number);
      const [hh,mi] = t.split(":").map(Number);
      const dt = new Date(yyyy, mm-1, dd, hh, mi, 0, 0);

      shiftStartMs = dt.getTime();
      saveData();
      closeModal("start-sort-modal");
      showSaveToast();
      renderAll();
    }

    function getShiftTimeWindows(){
      const shiftStart = shiftStartMs ? new Date(shiftStartMs) : new Date(new Date().setHours(0,0,0,0));
      const now = new Date();
      return { shiftStart, now };
    }

    /***********************
     * ADD TRAILER / ACTIVE DOORS
     ***********************/
    function addTrailer(){
      const trailerId = (document.getElementById("trailer-id").value || "").trim();
      const type = document.getElementById("trailer-type").value;
      const door = (document.getElementById("trailer-door").value || "").trim();
      const unloader = document.getElementById("trailer-unloader").value;

      if (!trailerId) return alert("Trailer ID is required.");
      if (!door) return alert("Door is required.");

      // Duplicate check (active)
      const dupActive = Object.values(activeDoors).some(d => d.trailerId === trailerId);
      if (dupActive) return alert(`Trailer "${trailerId}" is already active on a door.`);

      // Start time aligned to shift if shift started and no active history
      const nowMs = Date.now();
      const startMs = nowMs;

      activeDoors[door] = { trailerId, type, door, unloader, startMs };
      saveData();
      closeModal("add-trailer-modal");
      showSaveToast();
      renderAll();
    }

    function completeDoor(door){
      const d = activeDoors[door];
      if (!d) return;

      const nowMs = Date.now();
      const durationMs = Math.max(0, nowMs - d.startMs);

      historyLog.push({
        id: cryptoRandomId(),
        trailerId: d.trailerId,
        type: d.type,
        door: d.door,
        unloader: d.unloader,
        start: d.startMs,
        end: nowMs,
        durationMs
      });

      delete activeDoors[door];
      saveData();
      showSaveToast();
      renderAll();
    }

    function removeDoor(door){
      if (!activeDoors[door]) return;
      const ok = confirm(`Remove door ${door} without logging a completion?`);
      if (!ok) return;
      delete activeDoors[door];
      saveData();
      showSaveToast();
      renderAll();
    }

    /***********************
     * RENDER: DOORS
     ***********************/
    function renderDoors(){
      const wrap = document.getElementById("doors-table-wrap");
      const doors = Object.keys(activeDoors).sort((a,b)=> Number(a)-Number(b));

      document.getElementById("door-count").textContent = String(doors.length);

      if (doors.length === 0){
        wrap.innerHTML = `<div class="muted">No active doors.</div>`;
        return;
      }

      let html = `<table class="table">
        <thead>
          <tr>
            <th style="width:80px">Door</th>
            <th>Trailer</th>
            <th style="width:90px">Type</th>
            <th>Unloader</th>
            <th style="width:120px">Duration</th>
            <th style="width:210px">Actions</th>
          </tr>
        </thead>
        <tbody>`;

      const nowMs = Date.now();
      doors.forEach(door => {
        const d = activeDoors[door];
        const durMs = Math.max(0, nowMs - d.startMs);
        const durLabel = msToHM(durMs);

        const tagClass = d.type === 'Wally' ? 'wally' : 'cpu';

        html += `<tr>
          <td><strong>${escapeHtml(door)}</strong></td>
          <td>${escapeHtml(d.trailerId)}</td>
          <td><span class="tag ${tagClass}">${escapeHtml(d.type)}</span></td>
          <td>${escapeHtml(d.unloader || 'Unassigned')}</td>
          <td>${durLabel}</td>
          <td>
            <button class="action-btn mini" onclick="completeDoor('${escapeAttr(door)}')"><i class="ph ph-check"></i> Complete</button>
            <button class="action-btn mini" onclick="removeDoor('${escapeAttr(door)}')"><i class="ph ph-x"></i> Remove</button>
          </td>
        </tr>`;
      });

      html += `</tbody></table>`;
      wrap.innerHTML = html;

      // KPI update
      const counts = computeShiftCounts();
      document.getElementById("kpi-wally").textContent = counts.wally;
      document.getElementById("kpi-cpu").textContent = counts.cpu;

      const mh = computeTotalManHours();
      document.getElementById("kpi-mh").textContent = mh.toFixed(2);
    }

    function updateHeaderPills(){
      const { shiftStart, now } = getShiftTimeWindows();

      if (!shiftStartMs){
        document.getElementById("shift-label").textContent = "Not started";
      } else {
        const startStr = shiftStart.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const nowStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        document.getElementById("shift-label").textContent = `${startStr} → ${nowStr}`;
      }

      document.getElementById("log-count").textContent = String(historyLog.length);
    }

    /***********************
     * v3.29: Hour label verbiage fix
     ***********************/
    function getHourText(hour) {
      if (hour === 1) return "1st hour";
      if (hour === 2) return "2nd hour";
      if (hour === 3) return "3rd hour";
      if (hour === 4) return "4th hour";
      if (hour === 5) return "5th hour";
      if (hour === 6) return "6th hour";
      if (hour === 7) return "7th hour";
      if (hour === 8) return "8th hour";
      if (hour === 9) return "9th hour";
      if (hour === 10) return "10th hour";
      if (hour === 11) return "11th hour";
      if (hour === 12) return "12th hour";
      return `${hour}th hour`;
    }

    function renderHourlyBreakdown(){
      const wrap = document.getElementById("hourly-breakdown-wrap");

      if (!shiftStartMs){
        wrap.innerHTML = `<div class="muted">Start Sort to enable hourly breakdown.</div>`;
        return;
      }

      const { shiftStart, now } = getShiftTimeWindows();
      const shiftLogs = historyLog.filter(l => l.end >= shiftStart.getTime() && l.end <= now.getTime());

      // Wally-only (per your v3.20 note)
      const wallyLogs = shiftLogs.filter(l => l.type === 'Wally');

      const elapsedMs = Math.max(0, now.getTime() - shiftStart.getTime());
      const hoursElapsed = Math.max(1, Math.ceil(elapsedMs / 3600000));

      const buckets = [];
      for (let h=1; h<=hoursElapsed; h++){
        const start = shiftStart.getTime() + (h-1)*3600000;
        const end = shiftStart.getTime() + h*3600000;
        const count = wallyLogs.filter(l => l.end >= start && l.end < end).length;
        buckets.push({ hour:h, count });
      }

      const total = buckets.reduce((s,b)=>s+b.count,0);

      let html = `<table class="table">
        <thead>
          <tr>
            <th style="width:140px">Hour</th>
            <th>Wally Completions</th>
          </tr>
        </thead>
        <tbody>`;

      buckets.forEach(b=>{
        html += `<tr>
          <td><strong>${getHourText(b.hour)}</strong></td>
          <td>${b.count}</td>
        </tr>`;
      });

      html += `<tr>
        <td><strong>Total</strong></td>
        <td><strong>${total}</strong></td>
      </tr>`;

      html += `</tbody></table>`;

      wrap.innerHTML = html;
    }

    /***********************
     * STAFFING
     ***********************/
    function addEmployee(){
      const name = (document.getElementById("emp-name").value || "").trim();
      const role = document.getElementById("emp-role").value;

      if (!name) return alert("Name is required.");

      // If adding as Belt Tender and one exists (non-cut), confirm
      if (role === 'Belt Tender'){
        const currentBT = staffing.find(s => s.role === 'Belt Tender' && s.status !== 'cut');
        if (currentBT){
          const ok = confirm(`"${currentBT.name}" is currently Belt Tender. Switch Belt Tender to "${name}"?`);
          if (!ok) return;
          // Demote existing BT
          currentBT.role = 'Unloader';
        }
      }

      // If adding as Bulk Sweep and 2 exist (non-cut), demote lowest-hours
      if (role === 'Bulk Sweep'){
        const sweeps = staffing.filter(s => s.role === 'Bulk Sweep' && s.status !== 'cut');
        if (sweeps.length >= 2){
          sweeps.sort((a,b)=>calculateTotalHours(a)-calculateTotalHours(b));
          sweeps[0].role = 'Unloader';
        }
      }

      staffing.push({
        id: cryptoRandomId(),
        name,
        role,
        status: 'active',
        start: Date.now(),
        accumulated: 0
      });

      saveData();
      closeModal('add-employee-modal');
      showSaveToast();
      refreshTrailerUnloaderOptions();
      renderStaffingView();
      renderAll();
    }

    function renderStaffingView(){
      const wrap = document.getElementById("staffing-wrap");

      if (staffing.length === 0){
        wrap.innerHTML = `<div class="muted">No employees added yet.</div>`;
        return;
      }

      // Sort: active first, paused, then cut; within, by hours desc
      const sorted = [...staffing].sort((a,b)=>{
        const order = (s)=> s.status === 'active' ? 0 : (s.status === 'paused' ? 1 : 2);
        if (order(a) !== order(b)) return order(a)-order(b);
        return calculateTotalHours(b) - calculateTotalHours(a);
      });

      let html = `<table class="table">
        <thead>
          <tr>
            <th>Name</th>
            <th style="width:170px">Role</th>
            <th style="width:120px">Status</th>
            <th style="width:120px">Hours</th>
            <th style="width:240px">Actions</th>
          </tr>
        </thead>
        <tbody>`;

      sorted.forEach(s=>{
        const disabledAttr = (s.status === 'cut') ? 'disabled' : '';
        const hours = calculateTotalHours(s).toFixed(2);

        html += `<tr>
          <td><strong>${escapeHtml(s.name)}</strong></td>
          <td>
            <!-- v3.29 update: pass select element for revert on cancel -->
            <select class="role-select" onchange="saveStaffRole('${escapeAttr(s.id)}', this.value, this)" ${disabledAttr}>
              <option value="Unloader" ${s.role==='Unloader'?'selected':''}>Unloader</option>
              <option value="Belt Tender" ${s.role==='Belt Tender'?'selected':''}>Belt Tender</option>
              <option value="Bulk Sweep" ${s.role==='Bulk Sweep'?'selected':''}>Bulk Sweep</option>
            </select>
          </td>
          <td>
            <span class="tag ${escapeHtml(s.status)}">${escapeHtml(capitalize(s.status))}</span>
          </td>
          <td>${hours}</td>
          <td>
            <button class="action-btn mini" onclick="togglePause('${escapeAttr(s.id)}')" ${s.status==='cut'?'disabled':''}>
              <i class="ph ph-pause-circle"></i> ${s.status==='paused'?'Resume':'Pause'}
            </button>
            <button class="action-btn mini" onclick="cutEmployee('${escapeAttr(s.id)}')"><i class="ph ph-user-minus"></i> Cut</button>
          </td>
        </tr>`;
      });

      html += `</tbody></table>`;

      wrap.innerHTML = html;

      refreshTrailerUnloaderOptions();
    }

    function togglePause(id){
      const s = staffing.find(x=>String(x.id)===String(id));
      if (!s || s.status==='cut') return;

      const now = Date.now();

      if (s.status === 'active'){
        // move active time into accumulated
        if (s.start){
          s.accumulated = (s.accumulated || 0) + (now - s.start);
        }
        s.start = null;
        s.status = 'paused';
      } else if (s.status === 'paused'){
        s.start = now;
        s.status = 'active';
      }

      saveData();
      showSaveToast();
      renderStaffingView();
      renderAll();
    }

    function cutEmployee(id){
      const s = staffing.find(x=>String(x.id)===String(id));
      if (!s) return;

      const ok = confirm(`Cut "${s.name}"?`);
      if (!ok) return;

      const now = Date.now();

      if (s.status === 'active' && s.start){
        s.accumulated = (s.accumulated || 0) + (now - s.start);
      }
      s.start = null;
      s.status = 'cut';

      saveData();
      showSaveToast();
      renderStaffingView();
      renderAll();
    }

    function autoPauseCutCheck(){
      // Role constraints check (silent corrections)
      enforceRoleLimits();
      saveData();
      showSaveToast();
      renderStaffingView();
      renderAll();
    }

    function calculateTotalHours(s){
      const now = Date.now();
      const acc = s.accumulated || 0;
      if (s.status === 'active' && s.start){
        return (acc + (now - s.start)) / 3600000;
      }
      return acc / 3600000;
    }

    function enforceRoleLimits(){
      // Belt Tender: max 1 among non-cut
      const belt = staffing.filter(s => s.role==='Belt Tender' && s.status !== 'cut');
      if (belt.length > 1){
        // keep the highest-hours BT, demote the rest
        belt.sort((a,b)=>calculateTotalHours(b)-calculateTotalHours(a));
        belt.slice(1).forEach(s => s.role='Unloader');
      }

      // Bulk Sweep: max 2 among non-cut
      const sweeps = staffing.filter(s => s.role==='Bulk Sweep' && s.status !== 'cut');
      if (sweeps.length > 2){
        // keep top 2 hours, demote remainder
        sweeps.sort((a,b)=>calculateTotalHours(b)-calculateTotalHours(a));
        sweeps.slice(2).forEach(s => s.role='Unloader');
      }
    }

    /****************************************************
     * v3.29: Staffing role switching rules + confirmation
     ****************************************************/
    function saveStaffRole(id, newRole, selectEl = null) {
      const s = staffing.find(x => String(x.id) === String(id));
      if (!s) return;

      const oldRole = s.role;
      const now = Date.now();
      let limitChanged = false;

      // If no real change, do nothing
      if (oldRole === newRole) return;

      // Confirm Belt Tender handoff (only if another on-clock person holds it)
      if (newRole === 'Belt Tender') {
        const currentBT = staffing.find(other =>
          String(other.id) !== String(s.id) &&
          other.role === 'Belt Tender' &&
          other.status !== 'cut' // ignore cut staff
        );

        if (currentBT) {
          const ok = confirm(`"${currentBT.name}" is currently Belt Tender. Switch Belt Tender to "${s.name}"?`);
          if (!ok) {
            if (selectEl) selectEl.value = oldRole;
            return;
          }
        }
      }

      // LIMIT ENFORCEMENT (ignore cut staff)

      // Belt Tender: max 1 (non-cut only)
      if (newRole === 'Belt Tender') {
        staffing.forEach(other => {
          if (
            String(other.id) !== String(s.id) &&
            other.role === 'Belt Tender' &&
            other.status !== 'cut'
          ) {
            // Demote existing BT, preserving time accounting
            if (other.status === 'active' && other.start) {
              const ms = now - other.start;
              other.accumulated = (other.accumulated || 0) + ms;
              other.start = now;
            }
            other.role = 'Unloader';
            limitChanged = true;
          }
        });
      }

      // Bulk Sweep: max 2 (non-cut only)
      if (newRole === 'Bulk Sweep') {
        const sweeps = staffing.filter(other =>
          String(other.id) !== String(s.id) &&
          other.role === 'Bulk Sweep' &&
          other.status !== 'cut'
        );

        if (sweeps.length >= 2) {
          // Demote the lowest-hours sweep
          sweeps.sort((a, b) => calculateTotalHours(a) - calculateTotalHours(b));
          const toDemote = sweeps[0];

          if (toDemote.status === 'active' && toDemote.start) {
            const ms = now - toDemote.start;
            toDemote.accumulated = (toDemote.accumulated || 0) + ms;
            toDemote.start = now;
          }
          toDemote.role = 'Unloader';
          limitChanged = true;
        }
      }

      // Apply role change with correct time tracking
      if (s.status === 'active' && s.start) {
        const ms = now - s.start;
        s.accumulated = (s.accumulated || 0) + ms;
        s.start = now; // reset start for new role session
        s.role = newRole;
      } else if (s.status === 'paused') {
        s.role = newRole;
      } else {
        s.role = newRole;
      }

      // Final constraints pass (silent)
      enforceRoleLimits();

      saveData();
      renderStaffingView();
      showSaveToast();
      renderAll();

      // kept intentionally silent (per your smoother-flow direction)
      void(limitChanged);
    }

    /***********************
     * LOGS
     ***********************/
    function renderLogs(){
      const wrap = document.getElementById("logs-wrap");

      if (historyLog.length === 0){
        wrap.innerHTML = `<div class="muted">No logs yet.</div>`;
        return;
      }

      const search = (document.getElementById("log-search").value || "").trim().toLowerCase();
      const typeFilter = document.getElementById("log-type-filter").value;
      const dateFilter = document.getElementById("log-date-filter").value; // YYYY-MM-DD

      let logs = [...historyLog].sort((a,b)=> b.end - a.end);

      if (typeFilter !== "All"){
        logs = logs.filter(l => l.type === typeFilter);
      }
      if (dateFilter){
        const [yyyy,mm,dd] = dateFilter.split("-").map(Number);
        const start = new Date(yyyy, mm-1, dd, 0,0,0,0).getTime();
        const end = new Date(yyyy, mm-1, dd, 23,59,59,999).getTime();
        logs = logs.filter(l => l.end >= start && l.end <= end);
      }
      if (search){
        logs = logs.filter(l =>
          String(l.id).toLowerCase().includes(search) ||
          String(l.trailerId).toLowerCase().includes(search)
        );
      }

      let html = `<table class="table">
        <thead>
          <tr>
            <th style="width:140px">Time</th>
            <th style="width:120px">Door</th>
            <th>Trailer</th>
            <th style="width:90px">Type</th>
            <th>Unloader</th>
            <th style="width:120px">Duration</th>
          </tr>
        </thead>
        <tbody>`;

      logs.forEach(l=>{
        const end = new Date(l.end);
        const timeStr = end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const tagClass = l.type === 'Wally' ? 'wally' : 'cpu';

        html += `<tr>
          <td>${timeStr}</td>
          <td><strong>${escapeHtml(l.door)}</strong></td>
          <td>${escapeHtml(l.trailerId)}</td>
          <td><span class="tag ${tagClass}">${escapeHtml(l.type)}</span></td>
          <td>${escapeHtml(l.unloader || 'Unassigned')}</td>
          <td>${msToHM(l.durationMs)}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      wrap.innerHTML = html;

      document.getElementById("log-count").textContent = String(historyLog.length);
    }

    /***********************
     * TOP PERFORMER (Shift)
     ***********************/
    function renderTopPerformer(){
      const el = document.getElementById("top-performer-box");
      if (!el) return;

      if (!shiftStartMs){
        el.innerHTML = `<div class="muted">Start Sort to enable shift-scoped ranking.</div>`;
        return;
      }

      const now = Date.now();
      const shiftLogs = historyLog.filter(l => l.end >= shiftStartMs && l.end <= now);

      if (shiftLogs.length === 0){
        el.innerHTML = `<div class="muted">n/a (no completed trailers logged for this shift)</div>`;
        return;
      }

      const volumeBy = {};
      shiftLogs.forEach(l=>{
        const name = l.unloader || "Unassigned";
        if (!volumeBy[name]) volumeBy[name] = { total:0, wally:0, cpu:0 };
        volumeBy[name].total++;
        if (l.type==='Wally') volumeBy[name].wally++;
        if (l.type==='CPU') volumeBy[name].cpu++;
      });

      // Hours by name from staffing (current)
      const hoursBy = {};
      staffing.forEach(s=>{
        const nm = s.name || "Unknown";
        const hrs = calculateTotalHours(s);
        hoursBy[nm] = (hoursBy[nm] || 0) + (isFinite(hrs)?hrs:0);
      });

      const rows = Object.keys(volumeBy).map(name=>{
        const v = volumeBy[name];
        const hrs = hoursBy[name] || 0;
        const rate = hrs > 0 ? (v.total / hrs) : 0;
        return { name, volume:v.total, wally:v.wally, cpu:v.cpu, hours:hrs, rate };
      });

      rows.sort((a,b)=>{
        if (b.volume !== a.volume) return b.volume - a.volume;
        if (b.rate !== a.rate) return b.rate - a.rate;
        return (b.hours||0) - (a.hours||0);
      });

      const top = rows[0];
      const rateStr = top.hours > 0 ? `${top.rate.toFixed(2)}/hr` : 'n/a';
      const hrsStr = top.hours > 0 ? `${top.hours.toFixed(2)}h` : 'n/a';

      el.innerHTML = `
        <div style="font-weight:900">${escapeHtml(top.name)}</div>
        <div class="muted" style="margin-top:6px;line-height:1.35">
          ${top.volume} trailers (W:${top.wally} | C:${top.cpu})<br/>
          Rate: ${rateStr} • Hours: ${hrsStr}
        </div>
      `;
    }

    /***********************
     * EXPORTS
     ***********************/
    function exportLogsJSON(){
      const payload = {
        type: "wally-tracker-logs-only",
        version: APP_VERSION,
        exportedAt: new Date().toISOString(),
        logs: historyLog
      };
      downloadTextFile(JSON.stringify(payload, null, 2), `wally-logs-${stamp()}.json`);
      showSaveToast();
    }

    function exportFullBackupJSON(){
      const payload = buildFullBackupPayload();
      downloadTextFile(JSON.stringify(payload, null, 2), `wally-full-backup-${stamp()}.json`);
      showSaveToast();
    }

    function exportSummaryText(){
      const text = generateEndSortSummaryText();
      downloadTextFile(text, `wally-summary-${stamp()}.txt`);
      showSaveToast();
    }

    function downloadTextFile(text, filename){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /***********************
     * RESTORE
     ***********************/
    function restoreFromJSON(){
      const raw = document.getElementById("restore-json").value;
      if (!raw.trim()) return alert("Paste JSON first.");

      let obj;
      try{
        obj = JSON.parse(raw);
      }catch(e){
        return alert("Invalid JSON.");
      }

      // logs-only restore
      if (obj && obj.type === "wally-tracker-logs-only" && Array.isArray(obj.logs)){
        const ok = confirm("Restore logs only? This will replace current logs.");
        if (!ok) return;
        historyLog = obj.logs;
        saveData();
        closeModal("restore-modal");
        showSaveToast();
        renderAll();
        return;
      }

      // full restore
      if (obj && obj.type === "wally-tracker-full-backup"){
        const ok = confirm("Restore full backup? This will replace current app data.");
        if (!ok) return;
        applyFullBackupPayload(obj);
        saveData();
        closeModal("restore-modal");
        showSaveToast();
        renderAll();
        return;
      }

      alert("Unrecognized backup format.");
    }

    /***********************
     * SETTINGS: RESET
     ***********************/
    function resetAllDataConfirm(){
      const ok = confirm("Reset ALL data? This clears doors, staffing, logs, and shift start.");
      if (!ok) return;

      activeDoors = {};
      staffing = [];
      historyLog = [];
      shiftStartMs = null;

      saveData();
      showSaveToast();
      renderAll();
    }

    /***********************
     * CHANGELOG
     ***********************/
    function openChangelog(){
      document.getElementById("changelog-text").value = CHANGELOG;
      openModal("changelog-modal");
    }

    /***********************
     * v3.30: END SORT SUMMARY REPORT
     ***********************/
    function openEndSortModal() {
      regenerateEndSortSummary();
      document.getElementById('end-sort-modal').style.display = 'flex';
    }

    function regenerateEndSortSummary() {
      const summary = generateEndSortSummaryText();
      const ta = document.getElementById('end-sort-summary-text');
      if (ta) ta.value = summary;
    }

    function copyEndSortSummary() {
      const ta = document.getElementById('end-sort-summary-text');
      const text = (ta && ta.value) ? ta.value : '';
      if (!text.trim()) return alert("Nothing to copy.");

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showSaveToast();
        }).catch(() => {
          fallbackCopyText();
        });
        return;
      }
      fallbackCopyText();
    }

    function fallbackCopyText() {
      const ta = document.getElementById('end-sort-summary-text');
      if (!ta) return alert("Copy failed. Please copy manually.");
      ta.focus();
      ta.select();
      try {
        document.execCommand('copy');
        showSaveToast();
      } catch (e) {
        alert("Copy failed. Please select the text and copy manually.");
      }
    }

    function generateEndSortSummaryText() {
      const now = new Date();
      const { shiftStart } = getShiftTimeWindows();
      const shiftStartMsLocal = shiftStart.getTime();
      const nowMs = now.getTime();

      const durMs = Math.max(0, nowMs - shiftStartMsLocal);
      const durH = Math.floor(durMs / 3600000);
      const durM = Math.floor((durMs % 3600000) / 60000);

      // Shift logs only (best-effort: uses current shift start)
      const shiftLogs = historyLog.filter(l => (l.end >= shiftStartMsLocal && l.end <= nowMs));

      const wallyCount = shiftLogs.filter(l => l.type === 'Wally').length;
      const cpuCount = shiftLogs.filter(l => l.type === 'CPU').length;
      const totalTrailers = wallyCount + cpuCount;

      // Volume by unloader (from logs)
      const volumeByUnloader = {};
      shiftLogs.forEach(l => {
        const name = l.unloader || "Unassigned";
        if (!volumeByUnloader[name]) volumeByUnloader[name] = { total: 0, wally: 0, cpu: 0 };
        volumeByUnloader[name].total++;
        if (l.type === 'Wally') volumeByUnloader[name].wally++;
        if (l.type === 'CPU') volumeByUnloader[name].cpu++;
      });

      // Hours by staff name (from staffing)
      const hoursByName = {};
      staffing.forEach(s => {
        const nm = s.name || "Unknown";
        const hrs = calculateTotalHours(s);
        hoursByName[nm] = (hoursByName[nm] || 0) + (isFinite(hrs) ? hrs : 0);
      });

      // Total man-hours by role
      let totalManHours = 0;
      let unloaderHours = 0;
      let beltHours = 0;
      let sweepHours = 0;

      staffing.forEach(s => {
        const hrs = calculateTotalHours(s);
        if (!isFinite(hrs)) return;

        totalManHours += hrs;
        if (s.role === 'Belt Tender') beltHours += hrs;
        else if (s.role === 'Bulk Sweep') sweepHours += hrs;
        else unloaderHours += hrs;
      });

      // Top performer: volume-first, then rate (trailers/hour), then hours
      const perfRows = Object.keys(volumeByUnloader).map(name => {
        const v = volumeByUnloader[name];
        const hrs = hoursByName[name] || 0;
        const rate = hrs > 0 ? (v.total / hrs) : 0;
        return { name, volume: v.total, wally: v.wally, cpu: v.cpu, hours: hrs, rate };
      });

      perfRows.sort((a, b) => {
        if (b.volume !== a.volume) return b.volume - a.volume;
        if (b.rate !== a.rate) return b.rate - a.rate;
        return (b.hours || 0) - (a.hours || 0);
      });

      const top = perfRows[0] || null;
      const top3 = perfRows.slice(0, 3);

      const dateStr = now.toLocaleDateString([], { weekday:'short', year:'numeric', month:'short', day:'2-digit' });
      const startStr = shiftStart.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
      const endStr = now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });

      const lines = [];
      lines.push(`End Sort Summary — Wally Tracker (v${APP_VERSION})`);
      lines.push(`Date: ${dateStr}`);
      lines.push(`Shift: ${startStr} → ${endStr} (${durH}h ${durM}m)`);
      lines.push(`Totals: ${totalTrailers} trailers (Wally: ${wallyCount} | CPU: ${cpuCount})`);
      lines.push(`Man-Hours: ${totalManHours.toFixed(2)} (Unloaders: ${unloaderHours.toFixed(2)} | Belt: ${beltHours.toFixed(2)} | Sweep: ${sweepHours.toFixed(2)})`);

      if (top) {
        const topRate = top.hours > 0 ? `${top.rate.toFixed(2)}/hr` : `n/a`;
        const topHours = top.hours > 0 ? `${top.hours.toFixed(2)}h` : `n/a`;
        lines.push(`Top Performer: ${top.name} — ${top.volume} trailers (W:${top.wally} | C:${top.cpu}) • Rate: ${topRate} • Hours: ${topHours}`);
      } else {
        lines.push(`Top Performer: n/a (no completed trailers logged for this shift)`);
      }

      if (top3.length > 0) {
        lines.push(``);
        lines.push(`Top 3 (by volume):`);
        top3.forEach((r, idx) => {
          const rate = r.hours > 0 ? `${r.rate.toFixed(2)}/hr` : `n/a`;
          const hrs = r.hours > 0 ? `${r.hours.toFixed(2)}h` : `n/a`;
          lines.push(`${idx + 1}) ${r.name}: ${r.volume} (W:${r.wally} | C:${r.cpu}) • Rate: ${rate} • Hours: ${hrs}`);
        });
      }

      return lines.join('\n');
    }

    /***********************
     * HELPERS: COUNTS / HOURS
     ***********************/
    function computeShiftCounts(){
      if (!shiftStartMs) {
        return {
          wally: historyLog.filter(l=>l.type==='Wally').length,
          cpu: historyLog.filter(l=>l.type==='CPU').length
        };
      }
      const now = Date.now();
      const shiftLogs = historyLog.filter(l => l.end >= shiftStartMs && l.end <= now);
      return {
        wally: shiftLogs.filter(l=>l.type==='Wally').length,
        cpu: shiftLogs.filter(l=>l.type==='CPU').length
      };
    }

    function computeTotalManHours(){
      let total = 0;
      staffing.forEach(s=>{
        const hrs = calculateTotalHours(s);
        if (isFinite(hrs)) total += hrs;
      });
      return total;
    }

    /***********************
     * UNLOADER DROPDOWN
     ***********************/
    function refreshTrailerUnloaderOptions(){
      const sel = document.getElementById("trailer-unloader");
      if (!sel) return;

      const names = staffing
        .filter(s => s.status !== 'cut')
        .map(s => s.name)
        .sort((a,b)=>a.localeCompare(b));

      const current = sel.value;

      sel.innerHTML = `<option value="Unassigned">Unassigned</option>` + names.map(n => {
        const safe = escapeHtml(n);
        return `<option value="${escapeAttr(n)}">${safe}</option>`;
      }).join("");

      // keep selection if possible
      if ([...sel.options].some(o => o.value === current)){
        sel.value = current;
      } else {
        sel.value = "Unassigned";
      }
    }

    /***********************
     * STORAGE
     ***********************/
    function saveData(){
      const payload = buildFullBackupPayload();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;

      try{
        const obj = JSON.parse(raw);
        applyFullBackupPayload(obj);
      }catch(e){
        // ignore corrupt storage
      }
    }

    function buildFullBackupPayload(){
      return {
        type: "wally-tracker-full-backup",
        version: APP_VERSION,
        savedAt: new Date().toISOString(),
        shiftStartMs,
        activeDoors,
        staffing,
        historyLog
      };
    }

    function applyFullBackupPayload(obj){
      if (!obj || (obj.type !== "wally-tracker-full-backup" && obj.type !== "wally-tracker-logs-only")) return;

      if (obj.type === "wally-tracker-full-backup"){
        shiftStartMs = obj.shiftStartMs || null;
        activeDoors = obj.activeDoors || {};
        staffing = obj.staffing || [];
        historyLog = obj.historyLog || [];
        // Normalize types
        if (!Array.isArray(staffing)) staffing = [];
        if (!Array.isArray(historyLog)) historyLog = [];
        if (!activeDoors || typeof activeDoors !== 'object') activeDoors = {};
      }

      if (obj.type === "wally-tracker-logs-only"){
        historyLog = obj.logs || [];
        if (!Array.isArray(historyLog)) historyLog = [];
      }

      // enforce constraints on load
      enforceRoleLimits();
    }

    /***********************
     * UTIL
     ***********************/
    function msToHM(ms){
      const m = Math.floor(ms / 60000);
      const h = Math.floor(m / 60);
      const rem = m % 60;
      if (h <= 0) return `${rem}m`;
      return `${h}h ${rem}m`;
    }

    function stamp(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${yyyy}${mm}${dd}-${hh}${mi}`;
    }

    function cryptoRandomId(){
      // Good enough for local IDs
      return Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);
    }

    function capitalize(s){ return (s||"").slice(0,1).toUpperCase() + (s||"").slice(1); }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){
      // Same as HTML escape for attributes
      return escapeHtml(str);
    }
  </script>
</body>
</html>
