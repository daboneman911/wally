<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="WallyTracker" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="mobile-web-app-capable" content="yes" />

  <title>Wally Dashboard</title>

  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #000000;
      --bg: #ffffff;
      --card-bg: #f5f5f5;
      --text-main: #000000;
      --text-sub: #757575;

      --bay-green: #4cd964;
      --bay-purple: #bf5af2;
      --bay-orange: #ff9500;
      --bay-red: #ff3b30;

      --safe-top: max(env(safe-area-inset-top), 47px);
      --safe-bottom: env(safe-area-inset-bottom);
      --tab-height: 80px;
    }

    body {
      font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      -webkit-font-smoothing: antialiased;
      -webkit-overflow-scrolling: touch;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding-top: calc(var(--safe-top) + 40px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      display: none;
      padding: 0 20px;
      padding-bottom: calc(var(--tab-height) + var(--safe-bottom) + 20px);
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }

    .tab-content.active { display: block; }

    .top-actions {
      display: flex;
      gap: 12px;
      padding: 10px 0 20px 0;
      justify-content: center;
    }

    .action-btn {
      background: #000;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.1s;
    }

    .action-btn:active { transform: scale(0.96); }

    .action-btn i { font-size: 18px; }

    .dashboard-header {
      background: #f2f2f7;
      border-radius: 20px;
      padding: 25px 20px;
      text-align: center;
      margin-bottom: 30px;
      margin-top: 10px;
    }

    .header-bar {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 50px;
      margin: 20px 0 20px 0;
    }

    .header-bar h1 {
      font-size: 24px;
      font-weight: 800;
      margin: 0;
    }

    .header-right {
      position: absolute;
      right: 0;
      display: flex;
      gap: 10px;
    }

    .filter-icon-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #000;
      border-radius: 50%;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-size: 20px;
      cursor: pointer;
      transition: background 0.1s;
    }
    .filter-icon-btn:active { background: #f0f0f0; }

    .export-icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background: #f2f2f7;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-size: 20px;
      cursor: pointer;
    }

    .app-title { font-size: 32px; font-weight: 900; margin: 0; letter-spacing: -0.5px; }
    .app-subtitle { font-size: 15px; color: var(--text-sub); margin-top: 4px; font-style: italic; }
    .app-version { font-size: 12px; color: #bbb; margin-top: 4px; font-weight: 600; }

    .section-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 20px;
      color: #000;
      text-align: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 90px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .stat-card:active { transform: scale(0.98); background: #ebebeb; }

    .stat-label { font-size: 13px; color: var(--text-sub); font-weight: 600; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 32px; font-weight: 800; color: #000; line-height: 1; }

    .bays-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 40px;
      min-height: 60px;
    }

    .empty-state-text {
      color: var(--text-sub);
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      width: 100%;
      padding: 20px 0;
    }

    .bay-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 800;
      color: #000;
      cursor: pointer;
      transition: transform 0.1s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
      box-sizing: border-box;
    }

    .bay-circle:active { transform: scale(0.92); }

    .bay-circle.unavailable {
      background-color: #8e8e93 !important;
      opacity: 0.5;
      color: #666;
      border: none !important;
      cursor: not-allowed;
    }

    .bay-circle.unavailable .bay-timer { color: #666; }

    .bay-9 { background-color: var(--bay-green); }
    .bay-10 { background-color: var(--bay-purple); }
    .bay-11 { background-color: var(--bay-orange); }
    .bay-12 { background-color: var(--bay-purple); }
    .bay-13 { background-color: var(--bay-orange); }
    .bay-14 { background-color: var(--bay-orange); }
    .bay-15 { background-color: var(--bay-orange); }
    .bay-16 { background-color: var(--bay-orange); }

    .type-badge {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 900;
      color: white;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .badge-w { background-color: #000; }
    .badge-c { background-color: #000; }

    .bay-timer {
      position: absolute;
      bottom: -5px;
      font-size: 9px;
      font-weight: 700;
      color: #000;
      background: rgba(255, 255, 255, 0.9);
      padding: 1px 4px;
      border-radius: 4px;
      min-width: 20px;
      text-align: center;
    }

    .active-tab-list { display: flex; flex-direction: column; gap: 15px; }

    .active-card {
      background: white;
      border: 2px solid #000;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .active-card-info { display: flex; flex-direction: column; gap: 6px; flex-grow: 1; }
    .active-card-header { display: flex; align-items: center; gap: 10px; }
    .active-card-title { font-size: 20px; font-weight: 800; color: #000; }
    .door-pill {
      background: #000; color: white;
      font-size: 12px; font-weight: 700;
      padding: 4px 10px; border-radius: 30px;
    }
    .active-card-details { font-size: 15px; color: var(--text-sub); font-weight: 500; }
    .active-card-time { font-size: 14px; color: #000; font-weight: 700; }

    .active-card-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
    }

    .icon-btn {
      background: #f2f2f7;
      border: none;
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: #000;
      font-size: 20px;
    }

    /* Staffing */
    .staffing-header-card {
      background: #000;
      color: #fff;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .staffing-header-title { font-size: 14px; opacity: 0.8; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
    .staffing-header-val { font-size: 32px; font-weight: 800; }

    .dop-container {
      margin-bottom: 20px;
      background: #fff;
      border: 1px solid #e5e5ea;
      border-radius: 16px;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .dop-label { font-size: 14px; font-weight: 700; color: #000; }
    .dop-select {
      background: #f2f2f7; border: none; padding: 8px 12px;
      border-radius: 8px; font-size: 14px; font-weight: 600;
    }

    .staff-section-title { font-size: 18px; font-weight: 800; margin: 25px 0 15px 0; display: flex; justify-content: space-between; align-items: center; }
    .staff-count-badge { background: #e5e5ea; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-left: 8px; }

    .staff-card {
      background: white; border: 1px solid #e5e5ea; border-radius: 18px;
      padding: 16px; margin-bottom: 12px;
      display: flex; flex-direction: column; gap: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    }

    .staff-card.cut { opacity: 0.6; background: #f9f9f9; }

    .staff-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .staff-name { font-size: 17px; font-weight: 700; color: #000; display: flex; align-items: center; gap: 6px; }
    .staff-time { font-size: 13px; color: var(--text-sub); margin-top: 2px; }
    .staff-hours { font-size: 16px; font-weight: 800; color: #000; font-variant-numeric: tabular-nums; }

    .staff-action-btn {
      background: #ffe5e5; color: #ff3b30; border: none;
      padding: 6px 10px; border-radius: 8px; font-size: 12px; font-weight: 700;
      cursor: pointer;
    }

    .role-select {
      width: 100%; padding: 8px; background: #f2f2f7; border: none;
      border-radius: 8px; font-size: 13px; font-weight: 600; color: #000;
      margin-top: 4px;
    }

    .breakdown-row {
      display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.7);
      margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);
    }

    .staff-checkbox-list {
      max-height: 250px; overflow-y: auto; border: 1px solid #e5e5ea;
      border-radius: 12px; background: #f9f9f9;
    }
    .staff-checkbox-item {
      display: flex; align-items: center; padding: 12px 16px;
      border-bottom: 1px solid #e5e5ea; cursor: pointer;
    }
    .staff-checkbox-item:last-child { border-bottom: none; }
    .staff-checkbox-item input { margin-right: 12px; width: 20px; height: 20px; accent-color: #000; }
    .staff-checkbox-item span { font-size: 16px; font-weight: 500; }

    /* Tools */
    .tools-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      padding: 10px 0;
    }
    .tool-card {
      background: #fff;
      border-radius: 24px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      aspect-ratio: 1 / 1;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: transform 0.1s;
    }
    .tool-card:active { transform: scale(0.96); background: #f9f9f9; }
    .tool-icon-wrapper {
      width: 50px; height: 50px;
      background: #000;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 24px;
      margin-bottom: 12px;
    }
    .tool-title { font-size: 16px; font-weight: 700; color: #000; margin-bottom: 4px; }
    .tool-card.add {
      border: 2px dashed #ccc;
      background: transparent;
      box-shadow: none;
    }
    .tool-card.add .tool-icon-wrapper {
      background: #e5e5ea;
      color: #000;
    }

    /* Logs */
    .stats-collapse-btn {
      width: 100%;
      background: #f2f2f7;
      border: none;
      border-radius: 16px;
      padding: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      font-weight: 700;
      color: #000;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .stats-content-area {
      background: white;
      border: 1px solid #e5e5ea;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 25px;
      display: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }

    .stats-table { width: 100%; border-collapse: collapse; font-size: 15px; }
    .stats-table th { text-align: left; color: var(--text-sub); font-weight: 600; padding-bottom: 12px; border-bottom: 1px solid #e5e5ea; }
    .stats-table td { padding: 12px 0; border-bottom: 1px solid #f9f9f9; color: #000; font-weight: 500; }
    .stats-table td:last-child { font-weight: 800; text-align: right; }

    .active-filter-display {
      display: flex; align-items: center; justify-content: space-between;
      background: #000; color: white; padding: 12px 20px;
      border-radius: 16px; margin-bottom: 20px; font-weight: 600;
    }

    .logs-list { display: flex; flex-direction: column; gap: 15px; }

    .log-card {
      background: white; border: 1px solid #e5e5ea; border-radius: 20px;
      padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      display: flex; justify-content: space-between; align-items: flex-start;
    }

    .log-info { display: flex; flex-direction: column; gap: 6px; flex-grow: 1; }
    .log-door-pill {
      background: #000; color: #fff; font-size: 12px; font-weight: 700;
      padding: 4px 10px; border-radius: 30px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 6px;
      width: fit-content;
    }
    .log-type-pill {
      font-size: 12px; font-weight: 800; padding: 4px 10px; border-radius: 30px;
      background: #000; color: #fff; margin-left: 6px;
      display: inline-flex; align-items: center; justify-content: center;
    }
    .log-title { font-size: 18px; font-weight: 800; color: #000; }
    .log-details { font-size: 15px; color: var(--text-sub); }
    .log-timestamp { font-size: 14px; color: #000; font-weight: 700; margin-top: 4px; }
    .log-actions { display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }

    .log-action-btn {
      background: #f2f2f7; border: 1px solid #000; border-radius: 12px;
      padding: 8px 14px; font-size: 13px; font-weight: 700;
      color: #000; cursor: pointer; display: flex; align-items: center; gap: 6px;
    }

    .search-bar {
      width: 100%; padding: 14px;
      border: 1px solid #e5e5ea; border-radius: 12px;
      background: #f9f9f9; font-size: 16px;
      margin-bottom: 20px;
      outline: none;
    }

    /* Bottom nav */
    .tab-bar {
      position: fixed; bottom: 30px; left: 20px; right: 20px;
      background: white; border-radius: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      display: flex; justify-content: space-around; align-items: center;
      height: 70px; z-index: 1000;
    }

    .tab-btn {
      background: none; border: none; display: flex; flex-direction: column; align-items: center;
      color: #ccc; font-size: 11px; font-weight: 600; width: 60px; cursor: pointer; gap: 4px;
      position: relative;
    }
    .tab-btn i { font-size: 26px; }
    .tab-btn.active { color: #000; }

    .tab-badge {
      position: absolute;
      top: -4px;
      right: 0;
      background: #ff3b30;
      color: white;
      font-size: 10px;
      font-weight: 800;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border: 2px solid white;
    }
    .tab-badge.zero { background: #e5e5ea; color: #8e8e93; }
    .tab-badge.warning { background: #ff9500; }
    .tab-badge.success { background: #34c759; }

    .save-toast {
      position: fixed; bottom: 100px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color: white;
      padding: 8px 16px; border-radius: 20px;
      font-size: 12px; font-weight: 600;
      display: flex; align-items: center; gap: 6px;
      z-index: 3000; opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .save-toast.visible { opacity: 1; }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); z-index: 2000;
      display: none; justify-content: center; align-items: flex-end;
      backdrop-filter: blur(4px);
    }

    .modal-sheet {
      background: white; width: 100%; max-width: 600px;
      border-top-left-radius: 28px; border-top-right-radius: 28px;
      padding: 30px; padding-bottom: max(40px, var(--safe-bottom));
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .form-input {
      width: 100%; padding: 18px; background: #f2f2f7; border: none;
      border-radius: 16px; font-size: 18px; margin-bottom: 15px;
      box-sizing: border-box; outline: none; appearance: none;
      color: #000; font-weight: 500;
    }

    .type-selector {
      display: flex; background: #f2f2f7; padding: 5px;
      border-radius: 16px; margin-bottom: 25px;
    }

    .type-opt {
      flex: 1; text-align: center; padding: 12px;
      border-radius: 12px; font-weight: 700; font-size: 15px;
      color: var(--text-sub); cursor: pointer;
    }

    .type-opt.selected {
      background: white; color: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .btn-primary {
      width: 100%; padding: 18px; border-radius: 16px;
      border: none; font-size: 17px; font-weight: 800;
      background: #000; color: white; margin-top: 10px; cursor: pointer;
    }
    .btn-danger { background: #ff3b30; }
    .btn-history { background: #f2f2f7; color: #000; margin-top: 10px; }

    .btn-cancel {
      background: transparent; color: var(--text-sub); width: 100%;
      padding: 15px; border: none; font-size: 16px; font-weight: 600;
      margin-top: 5px; cursor: pointer;
    }

    .detail-row {
      display: flex; justify-content: space-between;
      padding: 12px 0; border-bottom: 1px solid #f2f2f7;
    }
    .detail-label { color: var(--text-sub); font-weight: 600; font-size: 15px; }
    .detail-value { font-weight: 700; color: #000; font-size: 15px; }

    .modal-actions-row { display: flex; gap: 15px; margin-top: 10px; }
    .modal-icon-btn {
      background: #f2f2f7; border: none; width: 56px; border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; cursor: pointer; color: #000;
    }

    .filter-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;
    }
    .filter-btn {
      background: #f2f2f7; padding: 15px 0; border-radius: 12px;
      text-align: center; font-weight: 700; font-size: 16px; cursor: pointer;
    }
    .filter-btn.active { background: #000; color: white; }

    /* Settings */
    .settings-header { font-size: 22px; font-weight: 800; margin: 30px 0 10px 0; color: #000; }
    .settings-group {
      background: #fff; border-radius: 16px; overflow: hidden;
      margin-bottom: 20px; border: 1px solid #e5e5ea;
    }
    .settings-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 20px; border-bottom: 1px solid #f2f2f7; background: #fff;
    }
    .settings-row:last-child { border-bottom: none; }
    .settings-label { font-size: 16px; font-weight: 600; color: #000; }

    .settings-input-inline {
      background: #f2f2f7; border: none; padding: 8px 12px;
      border-radius: 8px; font-size: 16px; width: 110px; text-align: right;
    }

    .settings-btn-inline {
      background: #000; color: #fff; border: none;
      border-radius: 8px; padding: 6px 12px; font-weight: 600; font-size: 14px;
    }

    .toggle-switch {
      width: 50px; height: 30px; background: #e5e5ea;
      border-radius: 15px; position: relative; cursor: pointer;
      transition: background 0.2s;
    }
    .toggle-switch.checked { background: #000; }
    .toggle-switch::after {
      content: ''; position: absolute; left: 2px; top: 2px;
      width: 26px; height: 26px; background: white;
      border-radius: 50%; transition: left 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .toggle-switch.checked::after { left: 22px; }

    .stepper { display: flex; align-items: center; background: #f2f2f7; border-radius: 8px; padding: 2px; }
    .stepper-btn { width: 32px; height: 32px; border: none; background: transparent; font-size: 18px; font-weight: 700; cursor: pointer; color: #000; }
    .stepper-val { font-size: 16px; font-weight: 600; width: 24px; text-align: center; }

    .segment-control { display: flex; background: #f2f2f7; border-radius: 8px; padding: 2px; }
    .segment-opt { padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; color: #8e8e93; cursor: pointer; }
    .segment-opt.selected { background: #fff; color: #000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    .settings-note { font-size: 13px; color: #8e8e93; padding: 0 10px; margin-bottom: 20px; line-height: 1.4; }

    .saved-accounts-list { padding: 0 20px 20px 20px; }
    .saved-acct-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid #f2f2f7; font-size: 16px; font-weight: 500;
    }
    .delete-acct-btn { color: #ff3b30; font-size: 20px; cursor: pointer; }

    /* Slider */
    .settings-slider-container { display: flex; flex-direction: column; gap: 15px; padding: 15px 20px; }
    .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .slider-value {
      font-size: 16px; font-weight: 700; color: #000;
      background: #f2f2f7; padding: 4px 10px; border-radius: 8px;
      min-width: 60px; text-align: center;
    }
    .slider-wrapper { position: relative; width: 100%; height: 40px; display: flex; align-items: center; }
    .slider-track { position: absolute; width: 100%; height: 6px; background: #e5e5ea; border-radius: 3px; z-index: 1; }
    .slider-fill { position: absolute; height: 6px; background: #000; border-radius: 3px; z-index: 2; transition: width 0.1s; }
    .slider-thumb {
      position: absolute; width: 30px; height: 30px; background: #000; border-radius: 15px;
      z-index: 3; transform: translateX(-50%); box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer; touch-action: none;
    }
    .slider-ticks { display: flex; justify-content: space-between; position: absolute; width: 100%; top: 25px; pointer-events: none; }
    .slider-tick { width: 1px; height: 8px; background: #ccc; position: relative; }
    .slider-tick-label {
      position: absolute; top: 12px; font-size: 11px; color: #8e8e93;
      transform: translateX(-50%); white-space: nowrap; font-weight: 600;
    }

    #restore-file-input { display: none; }
  </style>
</head>

<body>
<input type="file" id="restore-file-input" accept=".json" onchange="restoreData(this)" />

<div id="save-toast" class="save-toast">
  <i class="ph ph-check-circle" style="color:#4cd964; font-size:16px;"></i>
  <span>Saved</span>
</div>

<div class="app-container">

  <!-- DASHBOARD -->
  <div id="tab-dashboard" class="tab-content active">
    <div class="top-actions">
      <button class="action-btn" onclick="openStartSortFlow()"><i class="ph ph-play-circle"></i> Start Sort</button>
      <button class="action-btn" onclick="openAddUnloaderModal()"><i class="ph ph-user-plus"></i> Add Unloader</button>
      <button class="action-btn" onclick="openArrivalModal()"><i class="ph ph-truck"></i> Onboard</button>
    </div>

    <div class="dashboard-header">
      <h1 class="app-title">Wally Dashboard</h1>
      <div class="app-subtitle">by Fitz Joseph</div>
      <div class="app-version" id="version-label">Version 3.29</div>
    </div>

    <div class="section-title">Sort Statistics</div>
    <div class="stats-grid">
      <div class="stat-card" onclick="viewStatLogs('Wally')">
        <div class="stat-label">Total Wallies</div>
        <div class="stat-value" id="stat-total-wally">0</div>
      </div>
      <div class="stat-card" onclick="viewStatLogs('CPU')">
        <div class="stat-label">Total CPUs</div>
        <div class="stat-value" id="stat-total-cpu">0</div>
      </div>
      <div class="stat-card" onclick="viewStatLogs('Hour-0')">
        <div class="stat-label">Wallies This Hour</div>
        <div class="stat-value" id="stat-hour-wally">0</div>
      </div>
      <div class="stat-card" onclick="viewStatLogs('Hour-1')">
        <div class="stat-label">Wallies Last Hour</div>
        <div class="stat-value" id="stat-last-wally">0</div>
      </div>
    </div>

    <div class="section-title">Active Trailers</div>
    <div id="active-trailers-grid" class="bays-grid"></div>

    <div class="section-title">Open Bays</div>
    <div id="open-bays-grid" class="bays-grid"></div>

    <div style="height:100px;"></div>
  </div>

  <!-- ACTIVE -->
  <div id="tab-active" class="tab-content">
    <div class="header-bar"><h1>Active Details</h1></div>
    <div id="active-tab-list" class="active-tab-list"></div>
  </div>

  <!-- LOGS -->
  <div id="tab-logs" class="tab-content">
    <div class="header-bar">
      <h1>Logs</h1>
      <div class="header-right">
        <button class="filter-icon-btn" onclick="openFilterModal()"><i class="ph ph-faders"></i></button>
        <button class="export-icon-btn" onclick="openExportModal()"><i class="ph ph-export"></i></button>
      </div>
    </div>

    <input type="text" id="log-search" class="search-bar" placeholder="Search by Wally ID or Trailer..." oninput="renderLogs()" />

    <button class="stats-collapse-btn" onclick="toggleStats('unloader')">
      Unloader Statistics
      <i class="ph ph-caret-down" id="stats-caret"></i>
    </button>
    <div id="stats-content" class="stats-content-area">
      <table class="stats-table">
        <thead>
          <tr>
            <th>Name</th>
            <th style="text-align:center">Wally</th>
            <th style="text-align:center">CPU</th>
            <th style="text-align:right">Total</th>
          </tr>
        </thead>
        <tbody id="unloader-stats-body"></tbody>
      </table>
    </div>

    <button class="stats-collapse-btn" onclick="toggleStats('hourly')">
      Hourly Breakdown
      <i class="ph ph-caret-down" id="hourly-caret"></i>
    </button>
    <div id="hourly-content" class="stats-content-area">
      <table class="stats-table">
        <thead>
          <tr>
            <th>Hour</th>
            <th style="text-align:center">Count</th>
          </tr>
        </thead>
        <tbody id="hourly-stats-body"></tbody>
      </table>
    </div>

    <div id="active-filter-display" class="active-filter-display" style="display:none;">
      <span>Filtering: <span id="filter-text-display"></span></span>
      <i class="ph ph-x" style="cursor:pointer" onclick="clearLogFilter()"></i>
    </div>

    <div id="logs-list" class="logs-list"></div>
  </div>

  <!-- STAFFING -->
  <div id="tab-staffing" class="tab-content">
    <div class="header-bar">
      <h1>Staffing</h1>
      <div class="header-right">
        <button class="action-btn" style="padding:10px 16px; border-radius:20px; height:40px; font-size:14px;" onclick="openAddStaffModal()">
          <i class="ph ph-plus"></i> Add
        </button>
      </div>
    </div>

    <div class="dop-container">
      <span class="dop-label">Daily Operating Plan</span>
      <select id="dop-select" class="dop-select" onchange="saveDOP(this.value)">
        <option value="5-2">5-2</option>
        <option value="6-2">6-2</option>
        <option value="7-2">7-2</option>
        <option value="8-2">8-2</option>
      </select>
    </div>

    <div class="staffing-header-card">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
        <div>
          <div class="staffing-header-title">Active Staff</div>
          <div class="staffing-header-val" id="staff-active-count">0</div>
        </div>
        <div style="text-align:right;">
          <div class="staffing-header-title">Unloader Hours</div>
          <div class="staffing-header-val" id="staff-total-hours">0.0</div>
        </div>
      </div>
      <div class="breakdown-row">
        <span>Belt Hours: <span id="staff-belt-hours">0.0</span></span>
        <span>Sweep Hours: <span id="staff-sweep-hours">0.0</span></span>
      </div>
    </div>

    <div class="staff-section-title">On Clock <span class="staff-count-badge" id="badge-on-clock">0</span></div>
    <div id="staff-list-active"></div>

    <div class="staff-section-title" style="margin-top:40px; opacity:0.6;">Off Clock <span class="staff-count-badge" id="badge-off-clock">0</span></div>
    <div id="staff-list-cut"></div>
  </div>

  <!-- TOOLS -->
  <div id="tab-tools" class="tab-content" style="background:#f2f2f7;">
    <div style="background:white; padding:20px 20px 10px 20px; border-bottom:1px solid #e5e5ea; margin:-20px -20px 20px -20px;">
      <div class="header-bar" style="margin:0;"><h1>Tools</h1></div>
    </div>

    <div class="tools-grid">
      <div class="tool-card" onclick="openPPHModal()">
        <div class="tool-icon-wrapper"><i class="ph ph-calculator"></i></div>
        <div class="tool-title">PPH Calculator</div>
      </div>

      <div class="tool-card" onclick="alert('Observation Corner coming soon')">
        <div class="tool-icon-wrapper"><i class="ph ph-eye"></i></div>
        <div class="tool-title">Observation</div>
      </div>

      <div class="tool-card add" onclick="alert('More tools soon')">
        <div class="tool-icon-wrapper"><i class="ph ph-plus"></i></div>
        <div class="tool-title">Add Tool</div>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="tab-settings" class="tab-content" style="background:#f2f2f7; padding:0;">
    <div style="background:white; padding:20px 20px 10px 20px; border-bottom:1px solid #e5e5ea;">
      <div class="header-bar" style="margin:0;"><h1>Settings</h1></div>
    </div>

    <div style="padding:20px 20px 120px 20px;">
      <div class="settings-header">Data Management</div>
      <div class="settings-group">
        <div class="settings-row" onclick="backupData('full')" style="cursor:pointer;">
          <span class="settings-label">Save Full Backup File</span>
          <i class="ph ph-download-simple" style="color:#000; font-size:20px;"></i>
        </div>
        <div class="settings-row" onclick="backupData('logs')" style="cursor:pointer;">
          <span class="settings-label">Backup Logs Only</span>
          <i class="ph ph-file-text" style="color:#000; font-size:20px;"></i>
        </div>
        <div class="settings-row" onclick="triggerRestore()" style="cursor:pointer;">
          <span class="settings-label">Restore from Backup</span>
          <i class="ph ph-upload-simple" style="color:#000; font-size:20px;"></i>
        </div>
      </div>

      <div class="settings-header">Shift Configuration</div>
      <div class="settings-group">
        <div class="settings-row">
          <span class="settings-label">Shift Start Time</span>
          <input type="time" id="setting-shift-start" class="settings-input-inline" onchange="saveShiftStart(this.value)" />
        </div>

        <div class="settings-slider-container" style="border-top:1px solid #f2f2f7;">
          <div class="slider-header">
            <span class="settings-label">Attribution Window</span>
            <span class="slider-value" id="attribution-value">5m</span>
          </div>

          <div class="slider-wrapper">
            <div class="slider-track"></div>
            <div class="slider-fill" id="slider-fill"></div>
            <div class="slider-thumb" id="slider-thumb"></div>

            <div class="slider-ticks">
              <div class="slider-tick" style="left:0%"><div class="slider-tick-label">0</div></div>
              <div class="slider-tick" style="left:50%"><div class="slider-tick-label">5</div></div>
              <div class="slider-tick" style="left:100%"><div class="slider-tick-label">10</div></div>
            </div>
          </div>

          <div class="settings-note" style="margin-top:20px; padding:0;">
            Allow attributing trailers completed up to <span id="attr-note-val" style="font-weight:700; color:#000;">5</span> minutes after the hour to the previous hour.
          </div>
        </div>

        <div class="settings-row">
          <span class="settings-label">Disable Attribution</span>
          <div class="toggle-switch" id="switch-dis-window" onclick="toggleSwitch('dis-window')"></div>
        </div>
      </div>

      <div class="settings-header">Saved Accounts</div>
      <div class="settings-group">
        <div class="settings-row">
          <input type="text" id="new-account-input" class="form-input" style="margin:0; padding:10px; background:#f2f2f7; width:65%;"
                 placeholder="New Account Number" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()" />
          <button class="settings-btn-inline" onclick="addSavedAccount()">Add</button>
        </div>
        <div id="saved-accounts-list" class="saved-accounts-list">
          <div style="padding:15px 0; color:#8e8e93; text-align:center;">No saved accounts</div>
        </div>
      </div>

      <div class="settings-header">Changelog</div>
      <div class="settings-group">
        <div class="settings-row" onclick="viewChangelog()" style="cursor:pointer;">
          <span class="settings-label">View Version History</span>
          <i class="ph ph-caret-right" style="color:#ccc;"></i>
        </div>
      </div>

      <button class="btn-primary" onclick="resetData()" style="background:#ff3b30; margin-bottom:100px;">Reset All Data</button>
    </div>
  </div>

</div>

<nav class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('dashboard', this)" id="tab-btn-dashboard">
    <i class="ph ph-chart-pie-slice"></i><span>Home</span>
  </button>
  <button class="tab-btn" onclick="switchTab('active', this)" id="tab-btn-active">
    <i class="ph ph-truck-trailer"></i><span>Active</span>
    <span class="tab-badge" id="badge-active">0</span>
  </button>
  <button class="tab-btn" onclick="switchTab('logs', this)" id="tab-btn-logs">
    <i class="ph ph-list-dashes"></i><span>Logs</span>
  </button>
  <button class="tab-btn" onclick="switchTab('staffing', this)" id="tab-btn-staffing">
    <i class="ph ph-users"></i><span>Staffing</span>
    <span class="tab-badge" id="badge-staffing">0</span>
  </button>
  <button class="tab-btn" onclick="switchTab('tools', this)" id="tab-btn-tools">
    <i class="ph ph-toolbox"></i><span>Tools</span>
    <span class="tab-badge" id="badge-tools">0</span>
  </button>
  <button class="tab-btn" onclick="switchTab('settings', this)" id="tab-btn-settings">
    <i class="ph ph-gear"></i><span>Settings</span>
    <span class="tab-badge" id="badge-settings">0</span>
  </button>
</nav>

<!-- MODALS -->
<div class="modal-overlay" id="start-sort-modal-1"><div class="modal-sheet">
  <h2 style="text-align:center; margin-bottom:20px;">Start Sort (1/2)</h2>
  <div style="margin-bottom:20px;">
    <label class="settings-label" style="display:block; margin-bottom:10px;">Shift Start Time</label>
    <input type="time" id="start-sort-time" class="form-input" value="19:55" />
  </div>
  <button class="btn-primary" onclick="nextSortStep()">Next</button>
  <button class="btn-cancel" onclick="closeModal('start-sort-modal-1')">Cancel</button>
</div></div>

<div class="modal-overlay" id="start-sort-modal-2"><div class="modal-sheet">
  <h2 style="text-align:center; margin-bottom:20px;">Start Sort (2/2)</h2>
  <div style="margin-bottom:20px;">
    <label class="settings-label" style="display:block; margin-bottom:10px;">Daily Operating Plan</label>
    <select id="start-sort-dop" class="form-input">
      <option value="5-2">5-2</option>
      <option value="6-2">6-2</option>
      <option value="7-2">7-2</option>
      <option value="8-2">8-2</option>
    </select>
  </div>
  <button class="btn-primary" onclick="finishStartSort()">Start Shift</button>
  <button class="btn-cancel" onclick="closeModal('start-sort-modal-2')">Back</button>
</div></div>

<div class="modal-overlay" id="changelog-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 20px 0; font-size:24px; text-align:center;">Changelog</h2>
  <div id="changelog-content" style="max-height:300px; overflow-y:auto; font-size:14px; line-height:1.5; color:#333; white-space: pre-wrap;"></div>
  <button class="btn-cancel" onclick="closeModal('changelog-modal')" style="margin-top:20px;">Close</button>
</div></div>

<div class="modal-overlay" id="pph-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 20px 0; font-size:24px; text-align:center;">PPH Calculator</h2>
  <div style="background:#f2f2f7; border-radius:16px; padding:20px; margin-bottom:20px; text-align:center;">
    <div style="font-size:13px; color:#757575; font-weight:700; letter-spacing:0.5px; margin-bottom:5px;">TOTAL UNLOADER HOURS</div>
    <input type="number" id="pph-unloader-hours-input" class="form-input"
           style="font-size:32px; font-weight:800; color:#000; text-align:center; background:transparent; border:none; width:100%; padding:0; margin:0;"
           oninput="calculatePPH()" placeholder="0.00" />
    <div style="font-size:12px; color:#757575; margin-top:4px;">Excludes Belt Tenders & Sweeps</div>
  </div>
  <div style="margin-bottom:20px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Total Volume</label>
    <input type="number" id="pph-volume-input" class="form-input" placeholder="Enter package count" oninput="calculatePPH()" />
  </div>
  <div style="text-align:center; margin-bottom:30px;">
    <div style="font-size:14px; color:var(--text-sub); font-weight:700;">CURRENT PPH</div>
    <div style="font-size:60px; font-weight:900; color:#000; letter-spacing:-2px;" id="pph-result">0</div>
  </div>
  <div style="display:flex; gap:10px;">
    <button class="btn-primary" onclick="resetPPH()" style="background:#e5e5ea; color:#000; flex:1;">Reset</button>
    <button class="btn-cancel" onclick="closeModal('pph-modal')" style="flex:1; margin-top:0; border:1px solid #e5e5ea; border-radius:16px; padding:18px;">Close</button>
  </div>
</div></div>

<div class="modal-overlay" id="add-staff-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 20px 0; font-size:24px; text-align:center;">Clock In Staff</h2>
  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Select Employees</label>
    <div id="staff-checkbox-list" class="staff-checkbox-list"></div>
  </div>
  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Start Time Override (Optional)</label>
    <input type="time" id="staff-input-time" class="form-input" />
    <div style="font-size:12px; color:#8e8e93; margin-top:4px;">Leave blank for current shift start time</div>
  </div>
  <button class="btn-primary" onclick="confirmAddStaff()">Clock In</button>
  <button class="btn-cancel" onclick="closeModal('add-staff-modal')">Cancel</button>
</div></div>

<div class="modal-overlay" id="export-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 20px 0; font-size:24px; text-align:center;">Export Data</h2>
  <button class="btn-primary" onclick="exportLogsCSV()">Export CSV (Spreadsheet)</button>
  <button class="btn-primary" onclick="exportLogsPDF()" style="margin-top:10px; background:#e5e5ea; color:#000;">Export PDF (Report)</button>
  <button class="btn-cancel" onclick="closeModal('export-modal')">Cancel</button>
</div></div>

<div class="modal-overlay" id="hour-attribution-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 10px 0; font-size:24px; text-align:center;">Attribute Completion</h2>
  <p style="text-align:center; color:#757575; margin-bottom:25px; padding:0 10px;">
    This trailer was completed during the shift transition window (<span id="attribution-window-text">00-05</span>).
  </p>
  <button class="btn-primary" onclick="resolveAttribution('Previous')">Previous Hour</button>
  <button class="btn-primary" onclick="resolveAttribution('Current')" style="background:#f2f2f7; color:#000; margin-top:10px;">Current Hour</button>
</div></div>

<div class="modal-overlay" id="filter-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 20px 0; font-size:24px; text-align:center;">Filter Logs</h2>
  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">By Date</label>
    <input type="date" id="filter-date-input" class="form-input" style="padding:12px;" />
  </div>
  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">By Door</label>
    <div class="filter-grid" id="filter-grid"></div>
  </div>
  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; display:block; margin-bottom:5px;">By Unloader</label>
    <select id="filter-unloader-select" class="form-input">
      <option value="All">All Unloaders</option>
    </select>
  </div>
  <button class="btn-primary" onclick="applyFilter()">Apply Filters</button>
  <button class="btn-cancel" onclick="closeModal('filter-modal')">Cancel</button>
</div></div>

<div class="modal-overlay" id="duplicate-wally-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 10px 0; font-size:24px; text-align:center;">Duplicate Wally Detected</h2>
  <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px; font-size:14px; line-height:1.5;">
    <p style="margin:0 0 10px 0;">Wally <strong id="dup-wally-id"></strong> was already completed.</p>
    <div style="display:flex; justify-content:space-between;"><span style="color:#757575;">Door:</span><strong id="dup-door"></strong></div>
    <div style="display:flex; justify-content:space-between; margin-top:5px;"><span style="color:#757575;">Completed:</span><strong id="dup-time"></strong></div>
    <div style="display:flex; justify-content:space-between; margin-top:5px;"><span style="color:#757575;">Unloader:</span><strong id="dup-unloader"></strong></div>
  </div>
  <button class="btn-primary" onclick="continueWithDuplicate()">Continue Anyway</button>
  <button class="btn-cancel" onclick="closeModal('duplicate-wally-modal')" style="margin-top:10px;">Cancel</button>
</div></div>

<div class="modal-overlay" id="add-unloader-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 20px 0; font-size:24px; text-align:center;">Add New Unloader</h2>
  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Unloader Name</label>
    <input type="text" id="input-new-unloader-name" class="form-input" placeholder="e.g. John Doe" autocapitalize="words" />
  </div>
  <button class="btn-primary" onclick="confirmAddUnloader()">Add Name</button>
  <button class="btn-cancel" onclick="closeModal('add-unloader-modal')">Cancel</button>
</div></div>

<div class="modal-overlay" id="input-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 20px 0; font-size:24px; text-align:center;">Onboard Door <span id="modal-door-num"></span></h2>

  <div id="onboard-form-container">
    <div class="type-selector">
      <div class="type-opt selected" id="opt-wally" onclick="setType('Wally')">Wally</div>
      <div class="type-opt" id="opt-cpu" onclick="setType('CPU')">CPU (53')</div>
    </div>

    <div id="wally-inputs">
      <div style="margin-bottom:15px;">
        <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Wally Number</label>
        <input type="text" id="input-wally-id" class="form-input" placeholder="e.g. 5589" inputmode="numeric" pattern="[0-9]*"
               oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
      </div>
    </div>

    <div id="cpu-inputs" style="display:none;">
      <div style="margin-bottom:15px;">
        <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Trailer Number</label>
        <input type="text" id="input-trailer-id" class="form-input" placeholder="e.g. TRL123" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()" />
      </div>
      <div style="margin-bottom:15px;">
        <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Account Number</label>
        <input type="text" id="input-account-id" class="form-input" placeholder="e.g. ACCT456" autocapitalize="characters"
               oninput="this.value = this.value.toUpperCase()" list="saved-accounts-datalist" />
        <datalist id="saved-accounts-datalist"></datalist>
      </div>
    </div>

    <div style="margin-bottom:15px;">
      <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Assigned Unloader (Optional)</label>
      <select id="select-unloader" class="form-input" onchange="checkCustomUnloader(this)">
        <option value="" selected>Unassigned</option>
      </select>
      <input type="text" id="input-custom-unloader" class="form-input" style="display:none; margin-top:10px;" placeholder="Enter Name" autocapitalize="words" />
    </div>

    <div style="margin-bottom:15px;">
      <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Start Time</label>
      <input type="time" id="input-onboard-time" class="form-input" />
      <div style="font-size:12px; color:#8e8e93; margin-top:4px;">If blank, defaults to current time (or shift start for first onboard after Start Sort).</div>
    </div>

    <button class="btn-primary" id="btn-start-unload" onclick="confirmArrival()">Start Unload</button>
  </div>

  <button class="btn-primary" id="btn-toggle-availability" onclick="handleAvailabilityToggle()"
          style="background:white; border:2px solid #e5e5ea; color:#000; margin-top:10px;">
    Mark Unavailable
  </button>

  <button class="btn-cancel" onclick="closeModal('input-modal')">Cancel</button>
</div></div>

<div class="modal-overlay" id="active-detail-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 10px 0; font-size:24px; text-align:center;">Active Door <span id="detail-door-num"></span></h2>
  <div style="margin-bottom:25px;">
    <div class="detail-row"><span class="detail-label">Type</span><span class="detail-value" id="detail-type"></span></div>
    <div class="detail-row"><span class="detail-label">ID #</span><span class="detail-value" id="detail-id"></span></div>
    <div class="detail-row" id="row-account" style="display:none;"><span class="detail-label">Account #</span><span class="detail-value" id="detail-account"></span></div>
    <div class="detail-row"><span class="detail-label">Unloader</span><span class="detail-value" id="detail-unloader"></span></div>
    <div class="detail-row"><span class="detail-label">Start Time</span><span class="detail-value" id="detail-time"></span></div>
    <div class="detail-row"><span class="detail-label">Duration</span><span class="detail-value" id="detail-duration">0m</span></div>
  </div>

  <button class="btn-primary btn-danger" onclick="confirmCompleteDoor()">Complete Unload</button>

  <div class="modal-actions-row">
    <button class="modal-icon-btn" onclick="openEditActiveModalFromDetail()" style="flex:1"><i class="ph ph-pencil-simple"></i></button>
    <button class="btn-primary btn-history" onclick="viewDoorLogs(detailDoor)" style="flex:3; margin:0;">View History</button>
  </div>

  <button class="btn-cancel" onclick="closeModal('active-detail-modal')">Close</button>
</div></div>

<div class="modal-overlay" id="edit-active-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 20px 0; font-size:24px; text-align:center;">Edit Active Bay</h2>
  <input type="hidden" id="edit-active-original-door" />

  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Bay Number</label>
    <select id="edit-active-door-select" class="form-input"></select>
  </div>

  <div class="type-selector">
    <div class="type-opt selected" id="active-opt-wally" onclick="setEditActiveType('Wally')">Wally</div>
    <div class="type-opt" id="active-opt-cpu" onclick="setEditActiveType('CPU')">CPU</div>
  </div>

  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">ID / Trailer #</label>
    <input type="text" id="edit-active-id" class="form-input" oninput="this.value = this.value.toUpperCase()" />
  </div>

  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Account # (CPU only)</label>
    <input type="text" id="edit-active-account" class="form-input" oninput="this.value = this.value.toUpperCase()" />
  </div>

  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Unloader</label>
    <select id="edit-active-unloader" class="form-input" onchange="checkActiveCustomUnloader(this)"></select>
    <input type="text" id="edit-active-custom-unloader" class="form-input" style="display:none; margin-top:10px;" placeholder="Enter Name" autocapitalize="words" />
  </div>

  <button class="btn-primary" onclick="saveActiveEdit()">Save Changes</button>
  <button class="btn-cancel" onclick="closeModal('edit-active-modal')">Discard</button>
</div></div>

<div class="modal-overlay" id="edit-log-modal"><div class="modal-sheet">
  <h2 style="margin:0 0 20px 0; font-size:24px; text-align:center;">Edit Log Entry</h2>
  <input type="hidden" id="edit-log-index" />
  <div class="type-selector">
    <div class="type-opt selected" id="edit-opt-wally" onclick="setEditType('Wally')">Wally</div>
    <div class="type-opt" id="edit-opt-cpu" onclick="setEditType('CPU')">CPU (53')</div>
  </div>

  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">ID / Trailer #</label>
    <input type="text" id="edit-input-id" class="form-input" oninput="this.value = this.value.toUpperCase()" />
  </div>

  <div style="margin-bottom:15px;">
    <label style="font-size:12px; color:var(--text-sub); font-weight:600; margin-left:4px; margin-bottom:4px; display:block;">Unloader</label>
    <select id="edit-select-unloader" class="form-input"></select>
  </div>

  <button class="btn-primary" onclick="confirmLogEdit()">Save Changes</button>
  <button class="btn-cancel" onclick="closeModal('edit-log-modal')">Discard</button>
</div></div>

<script>
  /**********************
   * VERSION + CHANGELOG
   **********************/
  const APP_VERSION = "3.29";
  const CHANGELOG = `
v3.29:
- Staffing: Enforced correct role assignment for Belt Tender (max 1 on-clock) and Bulk Sweep (max 2 on-clock).
- Staffing: Added confirmation prompt before switching Belt Tender to a different employee.
- Staffing: Added confirmation prompt before bumping a Bulk Sweep when the max is already filled.
- Completions: Standardized hour wording to "1st hour, 2nd hour, 3rd hour, 4th hour, 5th hour" (and beyond).
- General: Version bump to 3.29.
`;

  /**********************
   * CONFIG / CONSTANTS
   **********************/
  const DOORS_START = 9;
  const DOORS_END = 16;

  const DEFAULT_TEAM = ["David F", "Lorena R", "Matt R", "Matt S", "Robert W", "Trevon C", "Victor M", "Russell H", "Fonseca J"];

  // LocalStorage keys
  const K_DOORS = "ps9_doors";
  const K_HISTORY = "ps9_history";
  const K_TEAM = "ps9_team";
  const K_ACCOUNTS = "ps9_accounts";
  const K_STAFFING = "ps9_staffing";
  const K_DOP = "ps9_dop";
  const K_SHIFT_START = "ps9_shift_start";
  const K_ATTR = "ps9_attribution_config_v2";
  const K_LAST_SORT_START = "ps9_last_sort_start";
  const K_IS_FIRST_ONBOARD = "ps9_is_first_onboard";

  /**********************
   * STATE
   **********************/
  let doors = {};        // { [doorNumber]: { status, start, id, type, unloader, account, unavailable, lastCompletionTime } }
  let historyLog = [];   // [{ ts, action:'complete', door, type, id, account, unloader, start, durationMin, hourIndex, hourLabel, attributedFromWindow }]
  let teamNames = [];
  let savedAccounts = [];
  let staffing = [];     // [{ id, name, start, end, status, role, accumulated }]

  let currentDoor = null;
  let currentType = "Wally";
  let detailDoor = null;

  // Logs filter
  let activeLogFilter = { door: "All", unloader: "All", date: "All", type: "All", search: "" };

  // Attribution
  let attributionConfig = { minutes: 5, enabled: true };
  let pendingCompletion = null;

  // Start Sort
  let lastSortStartTime = null;
  let isFirstOnboard = false;
  let currentDOP = "5-2";
  let tempSortStartTime = "";

  // Duplicate flow
  let pendingWallyDuplicate = null;

  /**********************
   * UTILS
   **********************/
  function pad2(n) { return String(n).padStart(2, "0"); }

  function formatTime(ts) {
    return new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }

  function formatDate(ts) {
    return new Date(ts).toLocaleDateString([], { year: "numeric", month: "2-digit", day: "2-digit" });
  }

  function minutesBetween(a, b) {
    return Math.max(0, Math.round((b - a) / 60000));
  }

  function showSaveToast() {
    const t = document.getElementById("save-toast");
    t.classList.add("visible");
    setTimeout(() => t.classList.remove("visible"), 1600);
  }

  function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.style.display = "none";
  }

  function openModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.style.display = "flex";
  }

  function getHourText(hour) {
    if (hour === 1) return "1st hour";
    if (hour === 2) return "2nd hour";
    if (hour === 3) return "3rd hour";
    if (hour === 4) return "4th hour";
    if (hour === 5) return "5th hour";
    if (hour === 6) return "6th hour";
    if (hour === 7) return "7th hour";
    if (hour === 8) return "8th hour";
    if (hour === 9) return "9th hour";
    if (hour === 10) return "10th hour";
    if (hour === 11) return "11th hour";
    if (hour === 12) return "12th hour";
    return `${hour}th hour`;
  }

  function getShiftStartTimeStr() {
    return localStorage.getItem(K_SHIFT_START) || "19:55";
  }

  function saveShiftStart(val) {
    localStorage.setItem(K_SHIFT_START, val || "19:55");
    renderDashboard();
    showSaveToast();
  }

  function getShiftStartDate() {
    const startStr = getShiftStartTimeStr();
    const [h, m] = startStr.split(":").map(Number);
    const now = new Date();
    const start = new Date(now);
    start.setHours(h, m, 0, 0);
    if (now < start) start.setDate(start.getDate() - 1);
    return start;
  }

  function getShiftHourIndexAt(ts) {
    const shiftStart = getShiftStartDate();
    const diffMs = ts - shiftStart.getTime();
    if (diffMs < 0) return 1;
    return Math.floor(diffMs / 3600000) + 1;
  }

  function getShiftHourBoundaryStart(hourIndex) {
    const shiftStart = getShiftStartDate();
    return new Date(shiftStart.getTime() + (hourIndex - 1) * 3600000);
  }

  function getShiftTimeWindows() {
    const shiftStart = getShiftStartDate();
    const now = new Date();
    const diffMs = now - shiftStart;
    const hoursElapsed = Math.max(0, Math.floor(diffMs / 3600000));
    const thisHourStart = new Date(shiftStart.getTime() + hoursElapsed * 3600000);
    const thisHourEnd = new Date(thisHourStart.getTime() + 3600000);
    const lastHourStart = new Date(thisHourStart.getTime() - 3600000);
    const lastHourEnd = thisHourStart;
    return { shiftStart, thisHourStart, thisHourEnd, lastHourStart, lastHourEnd };
  }

  function saveData() {
    localStorage.setItem(K_DOORS, JSON.stringify(doors));
    localStorage.setItem(K_HISTORY, JSON.stringify(historyLog));
    localStorage.setItem(K_TEAM, JSON.stringify(teamNames));
    localStorage.setItem(K_ACCOUNTS, JSON.stringify(savedAccounts));
    localStorage.setItem(K_STAFFING, JSON.stringify(staffing));
    localStorage.setItem(K_DOP, currentDOP);
    localStorage.setItem(K_LAST_SORT_START, lastSortStartTime || "");
    localStorage.setItem(K_IS_FIRST_ONBOARD, String(isFirstOnboard));
  }

  /**********************
   * INIT
   **********************/
  function init() {
    document.getElementById("version-label").textContent = `Version ${APP_VERSION}`;

    const sAttr = localStorage.getItem(K_ATTR);
    if (sAttr) {
      try { attributionConfig = JSON.parse(sAttr); } catch {}
    }

    const sDoors = localStorage.getItem(K_DOORS);
    if (sDoors) {
      try { doors = JSON.parse(sDoors); } catch { doors = {}; }
    }
    if (!sDoors || Object.keys(doors).length === 0) {
      for (let i = DOORS_START; i <= DOORS_END; i++) {
        doors[i] = { status: "empty", start: 0, id: "", type: "", unloader: "", account: "", unavailable: false, lastCompletionTime: null };
      }
    }

    const sHistory = localStorage.getItem(K_HISTORY);
    if (sHistory) {
      try { historyLog = JSON.parse(sHistory) || []; } catch { historyLog = []; }
    }

    const sTeam = localStorage.getItem(K_TEAM);
    if (sTeam) {
      try { teamNames = JSON.parse(sTeam) || []; } catch { teamNames = []; }
    }
    if (!teamNames || teamNames.length === 0) teamNames = [...DEFAULT_TEAM];

    const sAccts = localStorage.getItem(K_ACCOUNTS);
    if (sAccts) {
      try { savedAccounts = JSON.parse(sAccts) || []; } catch { savedAccounts = []; }
    }

    const sStaff = localStorage.getItem(K_STAFFING);
    if (sStaff) {
      try { staffing = JSON.parse(sStaff) || []; } catch { staffing = []; }
    }
    staffing.forEach(s => {
      if (!s.role) s.role = "Unloader";
      if (typeof s.accumulated !== "number") s.accumulated = 0;
    });

    const sDop = localStorage.getItem(K_DOP);
    if (sDop) currentDOP = sDop;

    lastSortStartTime = localStorage.getItem(K_LAST_SORT_START) || null;
    isFirstOnboard = (localStorage.getItem(K_IS_FIRST_ONBOARD) === "true");

    // Settings UI
    document.getElementById("setting-shift-start").value = getShiftStartTimeStr();
    document.getElementById("dop-select").value = currentDOP;

    // Attribution toggle UI
    const disWindowSwitch = document.getElementById("switch-dis-window");
    if (disWindowSwitch) {
      const disabled = !attributionConfig.enabled;
      disWindowSwitch.classList.toggle("checked", disabled);
    }

    renderSavedAccounts();
    updateAccountDatalist();
    populateUnloaderSelects();
    buildFilterGrid();
    refreshFilterUnloaderOptions();
    initAttributionSlider();

    renderDashboard();
    renderActiveTab();
    renderLogs();
    renderStaffingView();
    updateTabBadges();

    setInterval(() => {
      updateActiveDurations();
      updateTabBadges();
      if (document.getElementById("tab-staffing").classList.contains("active")) updateStaffingTimers();
    }, 1000);
  }

  /**********************
   * TABS
   **********************/
  function switchTab(tabName, btnEl) {
    document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
    document.getElementById(`tab-${tabName}`).classList.add("active");

    document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
    if (btnEl) btnEl.classList.add("active");

    if (tabName === "dashboard") renderDashboard();
    if (tabName === "active") renderActiveTab();
    if (tabName === "logs") renderLogs();
    if (tabName === "staffing") { renderStaffingView(); updateStaffingTimers(); }
    updateTabBadges();
  }

  /**********************
   * DASHBOARD RENDER
   **********************/
  function renderDashboard() {
    // Stats
    const totalWally = historyLog.filter(x => x.action === "complete" && x.type === "Wally").length;
    const totalCpu = historyLog.filter(x => x.action === "complete" && x.type === "CPU").length;

    const nowIdx = getShiftHourIndexAt(Date.now());
    const thisHourWally = historyLog.filter(x => x.action === "complete" && x.type === "Wally" && x.hourIndex === nowIdx).length;
    const lastHourWally = historyLog.filter(x => x.action === "complete" && x.type === "Wally" && x.hourIndex === (nowIdx - 1)).length;

    document.getElementById("stat-total-wally").textContent = totalWally;
    document.getElementById("stat-total-cpu").textContent = totalCpu;
    document.getElementById("stat-hour-wally").textContent = thisHourWally;
    document.getElementById("stat-last-wally").textContent = Math.max(0, lastHourWally);

    // Active trailers grid
    const activeGrid = document.getElementById("active-trailers-grid");
    activeGrid.innerHTML = "";
    const activeDoors = [];
    for (let d = DOORS_START; d <= DOORS_END; d++) {
      if (doors[d].status === "active") activeDoors.push(d);
    }
    if (activeDoors.length === 0) {
      activeGrid.innerHTML = `<div class="empty-state-text">No active trailers</div>`;
    } else {
      activeDoors.forEach(d => activeGrid.appendChild(makeBayCircle(d, "active")));
    }

    // Open bays grid
    const openGrid = document.getElementById("open-bays-grid");
    openGrid.innerHTML = "";
    const openDoors = [];
    for (let d = DOORS_START; d <= DOORS_END; d++) {
      if (doors[d].status === "empty") openDoors.push(d);
    }
    if (openDoors.length === 0) {
      openGrid.innerHTML = `<div class="empty-state-text">No open bays</div>`;
    } else {
      openDoors.forEach(d => openGrid.appendChild(makeBayCircle(d, "open")));
    }
  }

  function makeBayCircle(doorNum, mode) {
    const c = document.createElement("div");
    c.className = `bay-circle bay-${doorNum}`;
    c.dataset.door = String(doorNum);

    const state = doors[doorNum];
    if (state.unavailable) c.classList.add("unavailable");

    c.innerHTML = `<div>${doorNum}</div>`;

    // Type badge
    if (state.status === "active") {
      const badge = document.createElement("div");
      badge.className = `type-badge ${state.type === "CPU" ? "badge-c" : "badge-w"}`;
      badge.textContent = state.type === "CPU" ? "C" : "W";
      c.appendChild(badge);

      const t = document.createElement("div");
      t.className = "bay-timer";
      t.id = `bay-timer-${doorNum}`;
      t.textContent = `${minutesBetween(state.start, Date.now())}m`;
      c.appendChild(t);
    }

    if (state.unavailable) {
      c.onclick = () => { /* do nothing */ };
      return c;
    }

    if (mode === "open") {
      c.onclick = () => openDoorModal(doorNum);
    } else {
      c.onclick = () => openActiveDetailModal(doorNum);
    }
    return c;
  }

  function updateActiveDurations() {
    for (let d = DOORS_START; d <= DOORS_END; d++) {
      if (doors[d].status === "active") {
        const el = document.getElementById(`bay-timer-${d}`);
        if (el) el.textContent = `${minutesBetween(doors[d].start, Date.now())}m`;
      }
    }
    // Update detail modal duration if open
    if (detailDoor !== null && doors[detailDoor] && doors[detailDoor].status === "active") {
      const durEl = document.getElementById("detail-duration");
      if (durEl) durEl.textContent = `${minutesBetween(doors[detailDoor].start, Date.now())}m`;
    }
  }

  /**********************
   * ACTIVE TAB
   **********************/
  function renderActiveTab() {
    const list = document.getElementById("active-tab-list");
    list.innerHTML = "";

    const active = [];
    for (let d = DOORS_START; d <= DOORS_END; d++) {
      if (doors[d].status === "active") active.push(d);
    }

    if (active.length === 0) {
      list.innerHTML = `<div class="empty-state-text">No active trailers</div>`;
      return;
    }

    active.forEach(d => {
      const s = doors[d];
      const card = document.createElement("div");
      card.className = "active-card";

      const title = s.type === "CPU" ? (s.id || "CPU") : (s.id || "Wally");
      const detail = s.type === "CPU"
        ? `Trailer: ${s.id || "-"}  Account: ${s.account || "-"}`
        : `Wally: ${s.id || "-"}`;

      card.innerHTML = `
        <div class="active-card-info">
          <div class="active-card-header">
            <div class="door-pill">Door ${d}</div>
            <div class="active-card-title">${title}</div>
          </div>
          <div class="active-card-details">${detail}</div>
          <div class="active-card-time">Started ${formatTime(s.start)}  ${minutesBetween(s.start, Date.now())}m</div>
        </div>
        <div class="active-card-actions">
          <button class="icon-btn" onclick="openActiveDetailModal(${d})"><i class="ph ph-info"></i></button>
          <button class="icon-btn" onclick="confirmCompleteDoorFromDoor(${d})"><i class="ph ph-check"></i></button>
        </div>
      `;
      list.appendChild(card);
    });
  }

  /**********************
   * ONBOARDING
   **********************/
  function openArrivalModal() {
    // Choose first available empty door; if none, prompt to pick an active door to edit.
    const available = [];
    for (let d = DOORS_START; d <= DOORS_END; d++) {
      if (doors[d].status === "empty" && !doors[d].unavailable) available.push(d);
    }
    if (available.length === 0) {
      alert("No open bays available. Mark a bay available or complete an active trailer.");
      return;
    }
    openDoorModal(available[0]);
  }

  function openDoorModal(doorNum) {
    currentDoor = doorNum;
    document.getElementById("modal-door-num").textContent = doorNum;

    // defaults
    setType("Wally");
    document.getElementById("input-wally-id").value = "";
    document.getElementById("input-trailer-id").value = "";
    document.getElementById("input-account-id").value = "";
    document.getElementById("select-unloader").value = "";
    document.getElementById("input-custom-unloader").value = "";
    document.getElementById("input-custom-unloader").style.display = "none";
    document.getElementById("input-onboard-time").value = "";

    // Availability button label
    const btnAvail = document.getElementById("btn-toggle-availability");
    const isUnavail = !!doors[doorNum].unavailable;
    btnAvail.textContent = isUnavail ? "Mark Available" : "Mark Unavailable";

    openModal("input-modal");
  }

  function setType(type) {
    currentType = type;
    document.getElementById("opt-wally").classList.toggle("selected", type === "Wally");
    document.getElementById("opt-cpu").classList.toggle("selected", type === "CPU");
    document.getElementById("wally-inputs").style.display = (type === "Wally") ? "block" : "none";
    document.getElementById("cpu-inputs").style.display = (type === "CPU") ? "block" : "none";
  }

  function checkCustomUnloader(sel) {
    const custom = document.getElementById("input-custom-unloader");
    if (sel.value === "__custom__") {
      custom.style.display = "block";
      custom.focus();
    } else {
      custom.style.display = "none";
      custom.value = "";
    }
  }

  function handleAvailabilityToggle() {
    if (currentDoor === null) return;
    const d = currentDoor;

    if (doors[d].status === "active") {
      alert("You cannot change availability while the bay is active.");
      return;
    }

    doors[d].unavailable = !doors[d].unavailable;
    saveData();
    renderDashboard();
    renderActiveTab();

    const btnAvail = document.getElementById("btn-toggle-availability");
    btnAvail.textContent = doors[d].unavailable ? "Mark Available" : "Mark Unavailable";
    showSaveToast();
  }

  function confirmArrival() {
    if (currentDoor === null) return;

    const d = currentDoor;
    if (doors[d].unavailable) {
      alert("This bay is marked unavailable.");
      return;
    }
    if (doors[d].status === "active") {
      alert("This door is already active.");
      return;
    }

    // Unloader
    const unSel = document.getElementById("select-unloader").value;
    let unloader = "";
    if (unSel === "__custom__") {
      unloader = (document.getElementById("input-custom-unloader").value || "").trim();
    } else {
      unloader = unSel || "";
    }

    // Start time
    let startTs = Date.now();
    const t = document.getElementById("input-onboard-time").value;
    if (t) {
      const now = new Date();
      const [hh, mm] = t.split(":").map(Number);
      const dt = new Date(now);
      dt.setHours(hh, mm, 0, 0);
      // If time appears in future, assume previous day (common overnight behavior)
      if (dt.getTime() > now.getTime() + 2 * 60000) dt.setDate(dt.getDate() - 1);
      startTs = dt.getTime();
    } else if (isFirstOnboard) {
      // First onboard after Start Sort uses shift start time
      const shiftStart = getShiftStartDate();
      startTs = shiftStart.getTime();
      isFirstOnboard = false;
      localStorage.setItem(K_IS_FIRST_ONBOARD, "false");
    }

    // Type fields
    let id = "";
    let account = "";

    if (currentType === "Wally") {
      id = (document.getElementById("input-wally-id").value || "").trim();
      if (!id) return alert("Enter a Wally number.");

      // Duplicate check
      const prev = historyLog.find(x => x.action === "complete" && x.type === "Wally" && String(x.id) === String(id));
      if (prev) {
        pendingWallyDuplicate = { door: d, type: "Wally", id, account: "", unloader, startTs };
        document.getElementById("dup-wally-id").textContent = id;
        document.getElementById("dup-door").textContent = prev.door;
        document.getElementById("dup-time").textContent = `${formatDate(prev.ts)} ${formatTime(prev.ts)}`;
        document.getElementById("dup-unloader").textContent = prev.unloader || "Unassigned";
        openModal("duplicate-wally-modal");
        return;
      }
    } else {
      id = (document.getElementById("input-trailer-id").value || "").trim().toUpperCase();
      account = (document.getElementById("input-account-id").value || "").trim().toUpperCase();
      if (!id) return alert("Enter a Trailer number.");
    }

    // Start
    doors[d] = {
      ...doors[d],
      status: "active",
      start: startTs,
      id,
      type: currentType,
      unloader,
      account: currentType === "CPU" ? account : "",
      lastCompletionTime: null
    };

    saveData();
    closeModal("input-modal");

    renderDashboard();
    renderActiveTab();
    renderLogs();
    updateTabBadges();
    showSaveToast();
  }

  function continueWithDuplicate() {
    if (!pendingWallyDuplicate) return;
    const p = pendingWallyDuplicate;
    pendingWallyDuplicate = null;
    closeModal("duplicate-wally-modal");

    doors[p.door] = {
      ...doors[p.door],
      status: "active",
      start: p.startTs,
      id: p.id,
      type: p.type,
      unloader: p.unloader,
      account: "",
      lastCompletionTime: null
    };

    saveData();
    closeModal("input-modal");
    renderDashboard();
    renderActiveTab();
    renderLogs();
    updateTabBadges();
    showSaveToast();
  }

  /**********************
   * ACTIVE DETAIL + COMPLETE
   **********************/
  function openActiveDetailModal(doorNum) {
    if (!doors[doorNum] || doors[doorNum].status !== "active") return;
    detailDoor = doorNum;

    const s = doors[doorNum];
    document.getElementById("detail-door-num").textContent = doorNum;
    document.getElementById("detail-type").textContent = s.type;
    document.getElementById("detail-id").textContent = s.id || "-";
    document.getElementById("detail-unloader").textContent = s.unloader || "Unassigned";
    document.getElementById("detail-time").textContent = formatTime(s.start);
    document.getElementById("detail-duration").textContent = `${minutesBetween(s.start, Date.now())}m`;

    const rowAcct = document.getElementById("row-account");
    rowAcct.style.display = (s.type === "CPU") ? "flex" : "none";
    if (s.type === "CPU") document.getElementById("detail-account").textContent = s.account || "-";

    openModal("active-detail-modal");
  }

  function confirmCompleteDoorFromDoor(doorNum) {
    if (!doors[doorNum] || doors[doorNum].status !== "active") return;
    detailDoor = doorNum;
    confirmCompleteDoor();
  }

  function confirmCompleteDoor() {
    if (detailDoor === null) return;
    const d = detailDoor;
    const s = doors[d];
    if (!s || s.status !== "active") return;

    // Stage completion and apply attribution window if needed
    const completedTs = Date.now();
    const durationMin = minutesBetween(s.start, completedTs);

    const baseHourIndex = getShiftHourIndexAt(completedTs);
    const hourStart = getShiftHourBoundaryStart(baseHourIndex);
    const minutesAfterHour = Math.round((completedTs - hourStart.getTime()) / 60000);

    const inWindow = attributionConfig.enabled && attributionConfig.minutes > 0 && minutesAfterHour >= 0 && minutesAfterHour <= attributionConfig.minutes;
    if (inWindow && baseHourIndex > 1) {
      pendingCompletion = {
        door: d,
        type: s.type,
        id: s.id,
        account: s.account || "",
        unloader: s.unloader || "",
        start: s.start,
        completedTs,
        durationMin,
        baseHourIndex
      };
      document.getElementById("attribution-window-text").textContent = `00-${pad2(attributionConfig.minutes)}`;
      openModal("hour-attribution-modal");
      return;
    }

    // Normal finalize
    finalizeCompletion({
      door: d,
      type: s.type,
      id: s.id,
      account: s.account || "",
      unloader: s.unloader || "",
      start: s.start,
      completedTs,
      durationMin,
      hourIndex: baseHourIndex,
      attributedFromWindow: false
    });
  }

  function resolveAttribution(choice) {
    if (!pendingCompletion) return;
    const p = pendingCompletion;
    pendingCompletion = null;
    closeModal("hour-attribution-modal");

    let hourIndex = p.baseHourIndex;
    let attributedFromWindow = false;
    if (choice === "Previous") {
      hourIndex = Math.max(1, p.baseHourIndex - 1);
      attributedFromWindow = true;
    }

    finalizeCompletion({
      door: p.door,
      type: p.type,
      id: p.id,
      account: p.account,
      unloader: p.unloader,
      start: p.start,
      completedTs: p.completedTs,
      durationMin: p.durationMin,
      hourIndex,
      attributedFromWindow
    });
  }

  function finalizeCompletion({ door, type, id, account, unloader, start, completedTs, durationMin, hourIndex, attributedFromWindow }) {
    const hourLabel = getHourText(hourIndex);

    historyLog.unshift({
      action: "complete",
      ts: completedTs,
      door,
      type,
      id,
      account: type === "CPU" ? (account || "") : "",
      unloader: unloader || "",
      start,
      durationMin,
      hourIndex,
      hourLabel,
      attributedFromWindow: !!attributedFromWindow
    });

    // Clear door
    doors[door] = { ...doors[door], status: "empty", start: 0, id: "", type: "", unloader: "", account: "", lastCompletionTime: completedTs };

    saveData();

    closeModal("active-detail-modal");
    renderDashboard();
    renderActiveTab();
    renderLogs();
    updateTabBadges();
    showSaveToast();
  }

  /**********************
   * EDIT ACTIVE
   **********************/
  let editActiveType = "Wally";
  function openEditActiveModalFromDetail() {
    if (detailDoor === null) return;
    const d = detailDoor;
    const s = doors[d];
    if (!s || s.status !== "active") return;

    // door select
    const sel = document.getElementById("edit-active-door-select");
    sel.innerHTML = "";
    for (let i = DOORS_START; i <= DOORS_END; i++) {
      const option = document.createElement("option");
      option.value = String(i);
      option.textContent = `Door ${i}`;
      // allow selection if empty or same door and not unavailable
      const allowed = (i === d) || (doors[i].status === "empty" && !doors[i].unavailable);
      option.disabled = !allowed;
      if (i === d) option.selected = true;
      sel.appendChild(option);
    }

    document.getElementById("edit-active-original-door").value = String(d);

    // type
    editActiveType = s.type;
    setEditActiveType(editActiveType);

    document.getElementById("edit-active-id").value = s.id || "";
    document.getElementById("edit-active-account").value = s.account || "";

    // unloader select
    populateUnloaderSelect(document.getElementById("edit-active-unloader"), true);
    document.getElementById("edit-active-custom-unloader").style.display = "none";
    document.getElementById("edit-active-custom-unloader").value = "";

    // set unloader
    setUnloaderSelectValue(document.getElementById("edit-active-unloader"), s.unloader);

    openModal("edit-active-modal");
  }

  function setEditActiveType(type) {
    editActiveType = type;
    document.getElementById("active-opt-wally").classList.toggle("selected", type === "Wally");
    document.getElementById("active-opt-cpu").classList.toggle("selected", type === "CPU");
    // account input relevance; we keep it visible but you can ignore for Wally
  }

  function checkActiveCustomUnloader(sel) {
    const custom = document.getElementById("edit-active-custom-unloader");
    if (sel.value === "__custom__") {
      custom.style.display = "block";
      custom.focus();
    } else {
      custom.style.display = "none";
      custom.value = "";
    }
  }

  function saveActiveEdit() {
    const originalDoor = parseInt(document.getElementById("edit-active-original-door").value, 10);
    const newDoor = parseInt(document.getElementById("edit-active-door-select").value, 10);

    const s = doors[originalDoor];
    if (!s || s.status !== "active") return;

    const newId = (document.getElementById("edit-active-id").value || "").trim().toUpperCase();
    const newAcct = (document.getElementById("edit-active-account").value || "").trim().toUpperCase();

    if (!newId) return alert("ID / Trailer cannot be blank.");

    let unSel = document.getElementById("edit-active-unloader").value;
    let unloader = "";
    if (unSel === "__custom__") {
      unloader = (document.getElementById("edit-active-custom-unloader").value || "").trim();
    } else {
      unloader = unSel || "";
    }

    // Move door if needed
    if (newDoor !== originalDoor) {
      if (doors[newDoor].unavailable) return alert("Target door is unavailable.");
      if (doors[newDoor].status !== "empty") return alert("Target door is not empty.");
      doors[newDoor] = { ...s, id: newId, type: editActiveType, account: editActiveType === "CPU" ? newAcct : "", unloader };
      doors[originalDoor] = { ...doors[originalDoor], status: "empty", start: 0, id: "", type: "", unloader: "", account: "" };
      detailDoor = newDoor;
    } else {
      doors[originalDoor] = { ...s, id: newId, type: editActiveType, account: editActiveType === "CPU" ? newAcct : "", unloader };
    }

    saveData();
    closeModal("edit-active-modal");
    closeModal("active-detail-modal");
    renderDashboard();
    renderActiveTab();
    renderLogs();
    showSaveToast();
  }

  /**********************
   * LOGS
   **********************/
  let statsVisible = false;
  let hourlyVisible = false;

  function toggleStats(which) {
    if (which === "unloader") {
      statsVisible = !statsVisible;
      document.getElementById("stats-content").style.display = statsVisible ? "block" : "none";
      document.getElementById("stats-caret").className = statsVisible ? "ph ph-caret-up" : "ph ph-caret-down";
      if (statsVisible) renderUnloaderStats();
    }
    if (which === "hourly") {
      hourlyVisible = !hourlyVisible;
      document.getElementById("hourly-content").style.display = hourlyVisible ? "block" : "none";
      document.getElementById("hourly-caret").className = hourlyVisible ? "ph ph-caret-up" : "ph ph-caret-down";
      if (hourlyVisible) renderHourlyBreakdown();
    }
  }

  function renderLogs() {
    const container = document.getElementById("logs-list");
    container.innerHTML = "";

    const search = (document.getElementById("log-search").value || "").trim().toLowerCase();
    activeLogFilter.search = search;

    let logs = historyLog.filter(x => x.action === "complete");

    // Filter: door
    if (activeLogFilter.door !== "All") {
      logs = logs.filter(x => String(x.door) === String(activeLogFilter.door));
    }

    // Filter: unloader
    if (activeLogFilter.unloader !== "All") {
      logs = logs.filter(x => (x.unloader || "") === activeLogFilter.unloader);
    }

    // Filter: date
    if (activeLogFilter.date !== "All") {
      logs = logs.filter(x => {
        const d = new Date(x.ts);
        const iso = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        return iso === activeLogFilter.date;
      });
    }

    // Search: id, trailer, account, unloader
    if (search) {
      logs = logs.filter(x => {
        const hay = `${x.type} ${x.id} ${x.account || ""} ${x.unloader || ""} door ${x.door}`.toLowerCase();
        return hay.includes(search);
      });
    }

    // Filter banner
    const filterBanner = document.getElementById("active-filter-display");
    const filterText = document.getElementById("filter-text-display");
    const bannerParts = [];
    if (activeLogFilter.door !== "All") bannerParts.push(`Door ${activeLogFilter.door}`);
    if (activeLogFilter.unloader !== "All") bannerParts.push(activeLogFilter.unloader);
    if (activeLogFilter.date !== "All") bannerParts.push(activeLogFilter.date);
    if (bannerParts.length > 0) {
      filterBanner.style.display = "flex";
      filterText.textContent = bannerParts.join("  ");
    } else {
      filterBanner.style.display = "none";
    }

    if (logs.length === 0) {
      container.innerHTML = `<div class="empty-state-text">No logs found</div>`;
      if (statsVisible) renderUnloaderStats();
      if (hourlyVisible) renderHourlyBreakdown();
      return;
    }

    logs.forEach((x, idx) => {
      const card = document.createElement("div");
      card.className = "log-card";

      const title = x.type === "CPU" ? `CPU  ${x.id}` : `Wally  ${x.id}`;
      const details = x.type === "CPU"
        ? `Account: ${x.account || "-"}  Unloader: ${x.unloader || "Unassigned"}`
        : `Unloader: ${x.unloader || "Unassigned"}`;

      const ts = `${formatDate(x.ts)} ${formatTime(x.ts)}`;
      const hourTag = x.hourLabel ? `  ${x.hourLabel}` : "";

      card.innerHTML = `
        <div class="log-info">
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
            <span class="log-door-pill" onclick="quickFilterDoor(${x.door})"><i class="ph ph-door"></i> Door ${x.door}</span>
            <span class="log-type-pill">${x.type === "CPU" ? "CPU" : "WALLY"}</span>
          </div>
          <div class="log-title">${title}</div>
          <div class="log-details">${details}</div>
          <div class="log-timestamp">${ts}${hourTag}${x.attributedFromWindow ? "  (Attributed)" : ""}</div>
        </div>
        <div class="log-actions">
          <button class="log-action-btn" onclick="openEditLogModal(${historyLog.indexOf(x)})"><i class="ph ph-pencil-simple"></i> Edit</button>
          <button class="log-action-btn" onclick="deleteLogEntry(${historyLog.indexOf(x)})" style="border-color:#ff3b30; color:#ff3b30;"><i class="ph ph-trash"></i> Delete</button>
        </div>
      `;
      container.appendChild(card);
    });

    if (statsVisible) renderUnloaderStats();
    if (hourlyVisible) renderHourlyBreakdown();
  }

  function clearLogFilter() {
    activeLogFilter = { door: "All", unloader: "All", date: "All", type: "All", search: "" };
    document.getElementById("filter-date-input").value = "";
    document.getElementById("filter-unloader-select").value = "All";
    // clear door buttons
    buildFilterGrid();
    renderLogs();
  }

  function quickFilterDoor(doorNum) {
    activeLogFilter.door = String(doorNum);
    buildFilterGrid(String(doorNum));
    renderLogs();
  }

  function viewDoorLogs(doorNum) {
    activeLogFilter.door = String(doorNum);
    buildFilterGrid(String(doorNum));
    switchTab("logs", document.getElementById("tab-btn-logs"));
  }

  function viewStatLogs(kind) {
    // Simple shortcuts
    if (kind === "Wally") {
      activeLogFilter.door = "All";
      activeLogFilter.unloader = "All";
      activeLogFilter.date = "All";
      document.getElementById("log-search").value = "wally";
    } else if (kind === "CPU") {
      activeLogFilter.door = "All";
      activeLogFilter.unloader = "All";
      activeLogFilter.date = "All";
      document.getElementById("log-search").value = "cpu";
    } else if (kind === "Hour-0" || kind === "Hour-1") {
      // Filter by hour label by searching "1st hour" etc is not ideal; we just jump to logs and clear search.
      document.getElementById("log-search").value = "";
    }
    switchTab("logs", document.getElementById("tab-btn-logs"));
    renderLogs();
  }

  function deleteLogEntry(index) {
    if (!confirm("Delete this log entry?")) return;
    historyLog.splice(index, 1);
    saveData();
    renderLogs();
    renderDashboard();
    showSaveToast();
  }

  // Edit log
  let editLogType = "Wally";
  function openEditLogModal(index) {
    const entry = historyLog[index];
    if (!entry) return;

    document.getElementById("edit-log-index").value = String(index);

    editLogType = entry.type;
    setEditType(editLogType);

    document.getElementById("edit-input-id").value = entry.id || "";
    populateUnloaderSelect(document.getElementById("edit-select-unloader"), true);
    document.getElementById("edit-select-unloader").value = entry.unloader || "";

    openModal("edit-log-modal");
  }

  function setEditType(type) {
    editLogType = type;
    document.getElementById("edit-opt-wally").classList.toggle("selected", type === "Wally");
    document.getElementById("edit-opt-cpu").classList.toggle("selected", type === "CPU");
  }

  function confirmLogEdit() {
    const idx = parseInt(document.getElementById("edit-log-index").value, 10);
    const entry = historyLog[idx];
    if (!entry) return;

    const newId = (document.getElementById("edit-input-id").value || "").trim().toUpperCase();
    if (!newId) return alert("ID cannot be blank.");

    entry.type = editLogType;
    entry.id = newId;
    entry.unloader = document.getElementById("edit-select-unloader").value || "";

    saveData();
    closeModal("edit-log-modal");
    renderLogs();
    renderDashboard();
    showSaveToast();
  }

  // Stats tables
  function renderUnloaderStats() {
    const body = document.getElementById("unloader-stats-body");
    body.innerHTML = "";

    const logs = historyLog.filter(x => x.action === "complete");

    const map = new Map();
    logs.forEach(x => {
      const name = x.unloader || "Unassigned";
      if (!map.has(name)) map.set(name, { wally: 0, cpu: 0 });
      const v = map.get(name);
      if (x.type === "CPU") v.cpu += 1; else v.wally += 1;
    });

    const rows = [...map.entries()].map(([name, v]) => ({ name, wally: v.wally, cpu: v.cpu, total: v.wally + v.cpu }));
    rows.sort((a, b) => b.total - a.total);

    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.name}</td>
        <td style="text-align:center">${r.wally}</td>
        <td style="text-align:center">${r.cpu}</td>
        <td style="text-align:right">${r.total}</td>
      `;
      body.appendChild(tr);
    });

    if (rows.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" style="color:#8e8e93; text-align:center; padding:14px 0;">No data</td>`;
      body.appendChild(tr);
    }
  }

  function renderHourlyBreakdown() {
    // Wally-only, per earlier expectation
    const body = document.getElementById("hourly-stats-body");
    body.innerHTML = "";

    const logs = historyLog.filter(x => x.action === "complete" && x.type === "Wally");
    const counts = new Map();

    logs.forEach(x => {
      const k = x.hourIndex || 1;
      counts.set(k, (counts.get(k) || 0) + 1);
    });

    const keys = [...counts.keys()].sort((a, b) => a - b);
    keys.forEach(k => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${getHourText(k)}</td><td style="text-align:center">${counts.get(k)}</td>`;
      body.appendChild(tr);
    });

    if (keys.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="2" style="color:#8e8e93; text-align:center; padding:14px 0;">No Wally data</td>`;
      body.appendChild(tr);
    }
  }

  /**********************
   * FILTER MODAL
   **********************/
  function openFilterModal() {
    refreshFilterUnloaderOptions();
    openModal("filter-modal");
  }

  function buildFilterGrid(selectedDoor = null) {
    const grid = document.getElementById("filter-grid");
    grid.innerHTML = "";
    for (let d = DOORS_START; d <= DOORS_END; d++) {
      const b = document.createElement("div");
      b.className = "filter-btn";
      b.textContent = d;
      const active = (String(selectedDoor || activeLogFilter.door) === String(d));
      b.classList.toggle("active", active);
      b.onclick = () => {
        // toggle on/off
        if (activeLogFilter.door === String(d)) {
          activeLogFilter.door = "All";
        } else {
          activeLogFilter.door = String(d);
        }
        buildFilterGrid();
      };
      grid.appendChild(b);
    }
  }

  function refreshFilterUnloaderOptions() {
    const sel = document.getElementById("filter-unloader-select");
    const current = sel.value || "All";
    sel.innerHTML = `<option value="All">All Unloaders</option>`;

    // Collect from team + log history
    const set = new Set(teamNames);
    historyLog.forEach(x => { if (x.unloader) set.add(x.unloader); });
    set.add("Unassigned");

    [...set].sort().forEach(name => {
      const opt = document.createElement("option");
      opt.value = name === "Unassigned" ? "Unassigned" : name;
      opt.textContent = name;
      sel.appendChild(opt);
    });

    sel.value = current;
  }

  function applyFilter() {
    const dateVal = document.getElementById("filter-date-input").value;
    activeLogFilter.date = dateVal ? dateVal : "All";

    activeLogFilter.unloader = document.getElementById("filter-unloader-select").value || "All";

    closeModal("filter-modal");
    renderLogs();
  }

  /**********************
   * EXPORT
   **********************/
  function openExportModal() { openModal("export-modal"); }

  function exportLogsCSV() {
    const rows = historyLog.filter(x => x.action === "complete").map(x => ({
      Date: formatDate(x.ts),
      Time: formatTime(x.ts),
      Door: x.door,
      Type: x.type,
      ID: x.id,
      Account: x.account || "",
      Unloader: x.unloader || "",
      DurationMin: x.durationMin,
      Hour: x.hourLabel || "",
      Attributed: x.attributedFromWindow ? "Yes" : "No"
    }));

    const headers = Object.keys(rows[0] || {
      Date:"", Time:"", Door:"", Type:"", ID:"", Account:"", Unloader:"", DurationMin:"", Hour:"", Attributed:""
    });

    const csv = [
      headers.join(","),
      ...rows.map(r => headers.map(h => `"${String(r[h] ?? "").replace(/"/g, '""')}"`).join(","))
    ].join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `wally-logs-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    closeModal("export-modal");
    showSaveToast();
  }

  function exportLogsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "letter" });

    const rows = historyLog
      .filter(x => x.action === "complete")
      .slice(0, 300) // safety cap
      .map(x => [
        `${formatDate(x.ts)} ${formatTime(x.ts)}`,
        `Door ${x.door}`,
        x.type,
        x.id,
        x.account || "",
        x.unloader || "",
        x.hourLabel || ""
      ]);

    doc.setFontSize(14);
    doc.text(`Wally Tracker Report (v${APP_VERSION})`, 40, 40);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 58);

    doc.autoTable({
      head: [["Completed", "Door", "Type", "ID", "Account", "Unloader", "Hour"]],
      body: rows,
      startY: 70,
      styles: { fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [0,0,0] }
    });

    doc.save(`wally-report-${new Date().toISOString().slice(0,10)}.pdf`);
    closeModal("export-modal");
    showSaveToast();
  }

  /**********************
   * BACKUP / RESTORE
   **********************/
  function backupData(mode) {
    const data = {};
    if (mode === "logs") {
      data[K_HISTORY] = localStorage.getItem(K_HISTORY);
    } else {
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith("ps9_")) data[key] = localStorage.getItem(key);
      }
    }

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `wally-${mode}-backup-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showSaveToast();
  }

  function triggerRestore() {
    document.getElementById("restore-file-input").click();
  }

  function restoreData(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (!data || Object.keys(data).length === 0) throw new Error("Empty or invalid file");

        if (confirm("This will overwrite current data with the backup. Continue?")) {
          Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
          alert("Data restored successfully!");
          location.reload();
        }
      } catch (err) {
        alert("Error restoring data: " + err.message);
      } finally {
        input.value = "";
      }
    };
    reader.readAsText(file);
  }

  function resetData() {
    if (!confirm("Reset all data? This will preserve saved account numbers.")) return;
    const saved = [...savedAccounts];
    localStorage.clear();
    localStorage.setItem(K_SHIFT_START, "19:55");
    localStorage.setItem(K_ATTR, JSON.stringify({ minutes: 5, enabled: true }));
    localStorage.setItem(K_ACCOUNTS, JSON.stringify(saved));
    location.reload();
  }

  /**********************
   * CHANGELOG
   **********************/
  function viewChangelog() {
    document.getElementById("changelog-content").textContent = CHANGELOG;
    openModal("changelog-modal");
  }

  /**********************
   * START SORT FLOW
   **********************/
  function openStartSortFlow() {
    document.getElementById("start-sort-time").value = getShiftStartTimeStr();
    document.getElementById("start-sort-modal-1").style.display = "flex";
  }

  function nextSortStep() {
    const t = document.getElementById("start-sort-time").value;
    if (!t) return alert("Please select a time.");
    tempSortStartTime = t;

    document.getElementById("start-sort-dop").value = currentDOP;
    closeModal("start-sort-modal-1");
    openModal("start-sort-modal-2");
  }

  function finishStartSort() {
    const d = document.getElementById("start-sort-dop").value;

    saveShiftStart(tempSortStartTime);
    saveDOP(d);

    lastSortStartTime = tempSortStartTime;
    localStorage.setItem(K_LAST_SORT_START, lastSortStartTime);
    isFirstOnboard = true;
    localStorage.setItem(K_IS_FIRST_ONBOARD, "true");

    closeModal("start-sort-modal-2");
    showSaveToast();
  }

  function saveDOP(val) {
    currentDOP = val;
    localStorage.setItem(K_DOP, currentDOP);
    showSaveToast();
  }

  /**********************
   * ATTRIBUTION SLIDER
   **********************/
  function initAttributionSlider() {
    const valueEl = document.getElementById("attribution-value");
    const noteVal = document.getElementById("attr-note-val");
    const fillEl = document.getElementById("slider-fill");
    const thumbEl = document.getElementById("slider-thumb");

    function applyUI() {
      const val = attributionConfig.minutes;
      const pct = (val / 10) * 100;
      valueEl.textContent = `${val}m`;
      noteVal.textContent = `${val}`;
      fillEl.style.width = `${pct}%`;
      thumbEl.style.left = `${pct}%`;
    }

    function saveAttr() {
      localStorage.setItem(K_ATTR, JSON.stringify(attributionConfig));
      showSaveToast();
    }

    applyUI();

    const track = document.querySelector(".slider-track");
    if (!track || !thumbEl) return;

    let dragging = false;

    function update(clientX) {
      const rect = track.getBoundingClientRect();
      let pct = ((clientX - rect.left) / rect.width) * 100;
      pct = Math.max(0, Math.min(100, pct));
      const minuteValue = Math.round((pct / 100) * 10);
      attributionConfig.minutes = minuteValue;
      applyUI();
      saveAttr();
    }

    thumbEl.addEventListener("mousedown", (e) => { dragging = true; e.preventDefault(); });
    document.addEventListener("mousemove", (e) => { if (dragging) update(e.clientX); });
    document.addEventListener("mouseup", () => { dragging = false; });

    thumbEl.addEventListener("touchstart", (e) => { dragging = true; e.preventDefault(); }, { passive: false });
    document.addEventListener("touchmove", (e) => { if (dragging) update(e.touches[0].clientX); }, { passive: false });
    document.addEventListener("touchend", () => { dragging = false; });

    track.addEventListener("click", (e) => update(e.clientX));

    // Disable attribution switch
    const disWindowSwitch = document.getElementById("switch-dis-window");
    if (disWindowSwitch) {
      disWindowSwitch.onclick = () => toggleSwitch("dis-window");
    }
  }

  function toggleSwitch(id) {
    if (id !== "dis-window") return;
    const el = document.getElementById("switch-dis-window");
    el.classList.toggle("checked");
    const disabled = el.classList.contains("checked");
    attributionConfig.enabled = !disabled;
    localStorage.setItem(K_ATTR, JSON.stringify(attributionConfig));
    showSaveToast();
  }

  /**********************
   * UNLOADERS / TEAM
   **********************/
  function openAddUnloaderModal() {
    document.getElementById("input-new-unloader-name").value = "";
    openModal("add-unloader-modal");
  }

  function confirmAddUnloader() {
    const name = (document.getElementById("input-new-unloader-name").value || "").trim();
    if (!name) return alert("Enter a name.");
    if (!teamNames.includes(name)) {
      teamNames.push(name);
      teamNames.sort();
      saveData();
      populateUnloaderSelects();
      refreshFilterUnloaderOptions();
      showSaveToast();
    }
    closeModal("add-unloader-modal");
  }

  function populateUnloaderSelects() {
    populateUnloaderSelect(document.getElementById("select-unloader"), false);
    populateUnloaderSelect(document.getElementById("edit-select-unloader"), true);
    populateUnloaderSelect(document.getElementById("edit-active-unloader"), true);
  }

  function populateUnloaderSelect(sel, includeUnassigned) {
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = "";

    if (includeUnassigned) {
      const optAll = document.createElement("option");
      optAll.value = "";
      optAll.textContent = "Unassigned";
      sel.appendChild(optAll);
    } else {
      const optBlank = document.createElement("option");
      optBlank.value = "";
      optBlank.textContent = "Unassigned";
      sel.appendChild(optBlank);
    }

    teamNames.slice().sort().forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      sel.appendChild(opt);
    });

    const optCustom = document.createElement("option");
    optCustom.value = "__custom__";
    optCustom.textContent = "Custom";
    sel.appendChild(optCustom);

    // restore if possible
    if (current) sel.value = current;
  }

  function setUnloaderSelectValue(sel, value) {
    if (!sel) return;
    if (!value) { sel.value = ""; return; }
    const exists = [...sel.options].some(o => o.value === value);
    if (exists) {
      sel.value = value;
    } else {
      sel.value = "__custom__";
      const custom = document.getElementById("edit-active-custom-unloader");
      if (custom) {
        custom.style.display = "block";
        custom.value = value;
      }
    }
  }

  /**********************
   * SAVED ACCOUNTS
   **********************/
  function addSavedAccount() {
    const input = document.getElementById("new-account-input");
    const val = (input.value || "").trim().toUpperCase();
    if (!val) return;
    if (!savedAccounts.includes(val)) {
      savedAccounts.push(val);
      savedAccounts.sort();
      localStorage.setItem(K_ACCOUNTS, JSON.stringify(savedAccounts));
      renderSavedAccounts();
      updateAccountDatalist();
      showSaveToast();
    }
    input.value = "";
  }

  function removeAccount(acct) {
    savedAccounts = savedAccounts.filter(a => a !== acct);
    localStorage.setItem(K_ACCOUNTS, JSON.stringify(savedAccounts));
    renderSavedAccounts();
    updateAccountDatalist();
    showSaveToast();
  }

  function renderSavedAccounts() {
    const list = document.getElementById("saved-accounts-list");
    if (!list) return;
    list.innerHTML = "";
    if (savedAccounts.length === 0) {
      list.innerHTML = `<div style="padding:15px 0; color:#8e8e93; text-align:center;">No saved accounts</div>`;
      return;
    }
    savedAccounts.forEach(acct => {
      const div = document.createElement("div");
      div.className = "saved-acct-item";
      div.innerHTML = `<span>${acct}</span><i class="ph ph-minus-circle delete-acct-btn" onclick="removeAccount('${acct}')"></i>`;
      list.appendChild(div);
    });
  }

  function updateAccountDatalist() {
    const dl = document.getElementById("saved-accounts-datalist");
    if (!dl) return;
    dl.innerHTML = "";
    savedAccounts.forEach(acct => {
      const opt = document.createElement("option");
      opt.value = acct;
      dl.appendChild(opt);
    });
  }

  /**********************
   * STAFFING (UPDATED)
   **********************/
  function openAddStaffModal() {
    const container = document.getElementById("staff-checkbox-list");
    container.innerHTML = "";

    const activeNames = new Set(staffing.filter(s => s.status === "active" || s.status === "paused").map(s => s.name));

    [...teamNames].sort().forEach(n => {
      if (activeNames.has(n)) return;
      const item = document.createElement("label");
      item.className = "staff-checkbox-item";
      item.innerHTML = `<input type="checkbox" value="${n}" class="staff-checkbox"><span>${n}</span>`;
      container.appendChild(item);
    });

    document.getElementById("staff-input-time").value = "";
    openModal("add-staff-modal");
  }

  function confirmAddStaff() {
    const checked = document.querySelectorAll(".staff-checkbox:checked");
    const timeInput = document.getElementById("staff-input-time").value;

    if (checked.length === 0) return alert("Select at least one employee.");

    let startTs;
    if (timeInput) {
      const now = new Date();
      const [h, m] = timeInput.split(":").map(Number);
      const d = new Date(now);
      d.setHours(h, m, 0, 0);
      if (d.getTime() > now.getTime() + 2 * 60000) d.setDate(d.getDate() - 1);
      startTs = d.getTime();
    } else {
      startTs = getShiftStartDate().getTime();
    }

    checked.forEach(cb => {
      staffing.push({
        id: Date.now() + Math.random(),
        name: cb.value,
        start: startTs,
        end: null,
        status: "active",
        role: "Unloader",
        accumulated: 0
      });
    });

    saveData();
    closeModal("add-staff-modal");
    renderStaffingView();
    updateTabBadges();
    showSaveToast();
  }

  function isOnClock(st) {
    return st && (st.status === "active" || st.status === "paused");
  }

  function calculateTotalHours(st) {
    const now = Date.now();
    let ms = (st.accumulated || 0);
    if (st.status === "active" && st.start) ms += (now - st.start);
    const minutes = Math.round(ms / 60000);
    return minutes / 60;
  }

  function pauseStaff(id) {
    const s = staffing.find(x => x.id === id);
    if (!s || s.status !== "active") return;
    s.status = "paused";
    if (s.start) s.accumulated = (s.accumulated || 0) + (Date.now() - s.start);
    s.start = null;
    saveData();
    renderStaffingView();
    updateTabBadges();
    showSaveToast();
  }

  function resumeStaff(id) {
    const s = staffing.find(x => x.id === id);
    if (!s || s.status !== "paused") return;
    s.status = "active";
    s.start = Date.now();
    saveData();
    renderStaffingView();
    updateTabBadges();
    showSaveToast();
  }

  function cutStaff(id) {
    const s = staffing.find(x => x.id === id);
    if (!s) return;

    s.status = "cut";
    s.end = Date.now();
    if (s.start) s.accumulated = (s.accumulated || 0) + (Date.now() - s.start);
    s.start = null;

    // If they were special roles, revert
    if (s.role === "Belt Tender" || s.role === "Bulk Sweep") s.role = "Unloader";

    saveData();
    renderStaffingView();
    updateTabBadges();
    showSaveToast();
  }

  function removeStaff(id) {
    if (!confirm("Delete this employee record? This cannot be undone.")) return;
    staffing = staffing.filter(s => s.id !== id);
    saveData();
    renderStaffingView();
    updateTabBadges();
    showSaveToast();
  }

  // UPDATED ROLE ENFORCEMENT + CONFIRMATION
  function saveStaffRole(id, newRole, selectEl) {
    const s = staffing.find(x => x.id === id);
    if (!s) return;

    const oldRole = s.role || "Unloader";
    if (newRole === oldRole) return;

    const revertSelect = () => { if (selectEl) selectEl.value = oldRole; };

    // Belt Tender: max 1 on-clock, ask confirm before switching
    if (newRole === "Belt Tender") {
      const currentBelt = staffing.find(o => o.id !== s.id && isOnClock(o) && o.role === "Belt Tender");
      if (currentBelt) {
        const ok = confirm(
          `${currentBelt.name} is currently assigned as Belt Tender.\n\n` +
          `Do you want to assign Belt Tender to ${s.name} instead?\n` +
          `${currentBelt.name} will be moved to Unloader.`
        );
        if (!ok) { revertSelect(); return; }
      }
    }

    // Bulk Sweep: max 2 on-clock, ask confirm before bumping
    if (newRole === "Bulk Sweep") {
      const sweeps = staffing
        .filter(o => o.id !== s.id && isOnClock(o) && o.role === "Bulk Sweep")
        .map(o => ({ o, hours: calculateTotalHours(o) }))
        .sort((a,b) => a.hours - b.hours);

      if (sweeps.length >= 2) {
        const toDemote = sweeps[0].o;
        const ok = confirm(
          `Bulk Sweep is limited to 2 on-clock employees.\n\n` +
          `Do you want to assign Bulk Sweep to ${s.name}?\n` +
          `${toDemote.name} (lowest sweep hours) will be moved to Unloader.`
        );
        if (!ok) { revertSelect(); return; }
      }
    }

    const now = Date.now();

    // Apply demotions if needed
    if (newRole === "Belt Tender") {
      staffing.forEach(o => {
        if (o.id !== s.id && isOnClock(o) && o.role === "Belt Tender") {
          o.role = "Unloader";
        }
      });
    }

    if (newRole === "Bulk Sweep") {
      const sweeps = staffing
        .filter(o => o.id !== s.id && isOnClock(o) && o.role === "Bulk Sweep")
        .sort((a,b) => calculateTotalHours(a) - calculateTotalHours(b));
      if (sweeps.length >= 2) {
        sweeps[0].role = "Unloader";
      }
    }

    // Assign role to selected employee
    s.role = newRole;

    saveData();
    renderStaffingView();
    updateTabBadges();
    showSaveToast();
  }

  function renderStaffingView() {
    const activeList = document.getElementById("staff-list-active");
    const cutList = document.getElementById("staff-list-cut");
    activeList.innerHTML = "";
    cutList.innerHTML = "";

    const onClock = staffing.filter(s => s.status === "active" || s.status === "paused");
    onClock.sort((a,b) => calculateTotalHours(b) - calculateTotalHours(a));

    onClock.forEach(s => {
      const totalHours = calculateTotalHours(s);
      const isPaused = s.status === "paused";
      const timeStr = isPaused ? "Paused" : `Started: ${formatTime(s.start)}`;
      const roleColor = (s.role === "Belt Tender") ? "#ff9500" : (s.role === "Bulk Sweep") ? "#34c759" : "#000";

      const div = document.createElement("div");
      div.className = "staff-card";
      if (isPaused) div.style.cssText = "opacity:0.7; border:1px dashed #ccc;";

      div.innerHTML = `
        <div style="width:100%">
          <div class="staff-top-row">
            <div class="staff-name">${s.name}${isPaused ? ' <span style="background:#ffcc00; color:#000; font-size:10px; padding:2px 4px; border-radius:4px; font-weight:700; margin-left:6px;">PAUSED</span>' : ""}</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="icon-btn" onclick="${isPaused ? `resumeStaff(${s.id})` : `pauseStaff(${s.id})`}" style="width:32px; height:32px; font-size:16px; background:#e5e5ea;">
                <i class="ph ${isPaused ? "ph-play" : "ph-pause"}"></i>
              </button>
              <button class="staff-action-btn" onclick="cutStaff(${s.id})">CUT</button>
              <button class="icon-btn" onclick="removeStaff(${s.id})" style="width:32px; height:32px; font-size:16px; color:#ff3b30;">
                <i class="ph ph-trash"></i>
              </button>
            </div>
          </div>
          <div class="staff-time">${timeStr}  ${s.role}</div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
            <div class="staff-hours" id="staff-hours-${s.id}" style="color:${roleColor}">${totalHours.toFixed(2)}h</div>
            <div style="width:50%">
              <select class="role-select" onchange="saveStaffRole(${s.id}, this.value, this)">
                <option value="Unloader" ${s.role === "Unloader" ? "selected" : ""}>Unloader</option>
                <option value="Belt Tender" ${s.role === "Belt Tender" ? "selected" : ""}>Belt Tender</option>
                <option value="Bulk Sweep" ${s.role === "Bulk Sweep" ? "selected" : ""}>Bulk Sweep</option>
              </select>
            </div>
          </div>
        </div>
      `;
      activeList.appendChild(div);
    });

    const cut = staffing.filter(s => s.status === "cut");
    cut.sort((a,b) => calculateTotalHours(b) - calculateTotalHours(a));

    cut.forEach(s => {
      const hrs = calculateTotalHours(s);
      const div = document.createElement("div");
      div.className = "staff-card cut";
      div.innerHTML = `
        <div>
          <div class="staff-name">${s.name}  ${s.role}</div>
          <div class="staff-time">Ended: ${s.end ? formatTime(s.end) : "-"}</div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="staff-hours">${hrs.toFixed(2)}h</div>
          <button class="icon-btn" onclick="removeStaff(${s.id})" style="width:32px; height:32px; font-size:16px; color:#ff3b30; background:transparent;">
            <i class="ph ph-trash"></i>
          </button>
        </div>
      `;
      cutList.appendChild(div);
    });

    document.getElementById("badge-on-clock").textContent = String(onClock.length);
    document.getElementById("badge-off-clock").textContent = String(cut.length);

    updateStaffingTimers();
  }

  function updateStaffingTimers() {
    let onClockCount = 0;
    let offClockCount = 0;
    let totalUnloaderHours = 0;
    let beltHours = 0;
    let sweepHours = 0;

    staffing.forEach(s => {
      const hrs = calculateTotalHours(s);
      if (s.status === "active" || s.status === "paused") {
        onClockCount++;
        const el = document.getElementById(`staff-hours-${s.id}`);
        if (el) el.textContent = `${hrs.toFixed(2)}h`;
      } else if (s.status === "cut") {
        offClockCount++;
      }

      if (s.role === "Unloader") totalUnloaderHours += hrs;
      if (s.role === "Belt Tender") beltHours += hrs;
      if (s.role === "Bulk Sweep") sweepHours += hrs;
    });

    document.getElementById("staff-active-count").textContent = String(onClockCount);
    document.getElementById("staff-total-hours").textContent = totalUnloaderHours.toFixed(2);
    document.getElementById("staff-belt-hours").textContent = beltHours.toFixed(2);
    document.getElementById("staff-sweep-hours").textContent = sweepHours.toFixed(2);
  }

  /**********************
   * TAB BADGES
   **********************/
  function updateTabBadges() {
    const activeCount = Object.keys(doors).filter(k => doors[k].status === "active").length;
    updateBadge("active", activeCount, "activeTrailers");

    const staffCount = staffing.filter(s => s.status === "active" || s.status === "paused").length;
    updateBadge("staffing", staffCount, "activeStaff");

    updateBadge("tools", 0, "default");
    updateBadge("settings", 0, "default");
  }

  function updateBadge(tabId, count, type) {
    const badge = document.getElementById(`badge-${tabId}`);
    if (!badge) return;

    if (count === 0) {
      badge.textContent = "0";
      badge.classList.add("zero");
      badge.classList.remove("warning", "success");
      badge.style.display = "none";
      return;
    }

    badge.textContent = count > 99 ? "99+" : String(count);
    badge.classList.remove("zero");

    if (type === "activeTrailers") {
      badge.classList.toggle("warning", count >= 6);
      badge.classList.toggle("success", count >= 3 && count < 6);
      if (count < 3) badge.classList.remove("warning", "success");
    } else if (type === "activeStaff") {
      badge.classList.toggle("warning", count >= 8);
      badge.classList.toggle("success", count >= 4 && count < 8);
      if (count < 4) badge.classList.remove("warning", "success");
    } else {
      badge.classList.remove("warning", "success");
    }

    badge.style.display = "flex";
  }

  /**********************
   * PPH TOOL
   **********************/
  function openPPHModal() { openModal("pph-modal"); calculatePPH(); }

  function calculatePPH() {
    const hours = parseFloat(document.getElementById("pph-unloader-hours-input").value || "0");
    const volume = parseFloat(document.getElementById("pph-volume-input").value || "0");
    const pph = (hours > 0) ? (volume / hours) : 0;
    document.getElementById("pph-result").textContent = Number.isFinite(pph) ? Math.round(pph).toString() : "0";
  }

  function resetPPH() {
    document.getElementById("pph-unloader-hours-input").value = "";
    document.getElementById("pph-volume-input").value = "";
    calculatePPH();
  }

  /**********************
   * BOOT
   **********************/
  init();
</script>
</body>
</html>
